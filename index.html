<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>RRL Detective: Evidence ‚Üí Tentative Answer ‚Üí Research Gap</title>
  <style>
    :root{
      --bg:#f4f6f9; --card:#fff; --ink:#111827; --muted:#6b7280; --line:#e5e7eb;
      --accent:#111827; --warn:#fffbeb; --warnLine:#f59e0b; --ok:#ecfdf5; --okLine:#10b981;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:Arial, sans-serif;background:var(--bg);color:var(--ink)}
    header{background:var(--accent);color:#fff;padding:14px 18px;position:sticky;top:0;z-index:10}
    header .row{display:flex;gap:12px;align-items:center;justify-content:space-between;flex-wrap:wrap}
    h1{margin:0;font-size:18px}
    .badge{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border-radius:999px;background:rgba(255,255,255,.12)}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace}

    .container{max-width:1200px;margin:0 auto;padding:16px}
    .grid{display:grid;gap:12px}
    .grid.cols{grid-template-columns:390px 1fr}
    @media (max-width:980px){.grid.cols{grid-template-columns:1fr}}

    .panel{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:14px;box-shadow:0 1px 4px rgba(0,0,0,.06)}
    h2{margin:0 0 10px;font-size:16px}
    h3{margin:0 0 8px;font-size:14px}
    p{margin:8px 0;color:var(--muted);font-size:13px;line-height:1.45}
    hr{border:none;border-top:1px solid var(--line);margin:14px 0}

    button{border:0;border-radius:10px;padding:10px 12px;cursor:pointer;font-weight:700}
    button.primary{background:var(--accent);color:#fff}
    button.secondary{background:#e5e7eb;color:var(--ink)}
    button:disabled{opacity:.55;cursor:not-allowed}

    input[type="text"]{padding:10px 12px;border:1px solid var(--line);border-radius:10px;width:240px}

    .callout{
      border:1px solid var(--line);border-left:6px solid var(--accent);
      border-radius:12px;padding:10px 12px;background:#fff;
    }
    .callout b{font-size:13px}
    .callout ul{margin:8px 0 0;padding-left:18px;color:var(--muted);font-size:13px}
    .callout li{margin:4px 0}
    .miniDef{
      border:1px solid var(--line);border-radius:12px;padding:10px 12px;background:#fff;
      display:grid;gap:10px;
    }
    .miniDef .def{font-size:12px;color:var(--muted);line-height:1.45}
    .tag{font-size:11px;padding:3px 7px;border-radius:999px;background:#f3f4f6;color:var(--ink);display:inline-block;margin-right:6px;margin-top:6px}

    .twistBox{display:none;margin-top:10px;border:1px solid var(--warnLine);background:var(--warn);padding:10px 12px;border-radius:12px}
    .twistBox.show{display:block}

    .evidenceTray{min-height:120px;display:flex;flex-wrap:wrap;gap:10px;padding:10px;border:1px solid var(--line);border-radius:12px;background:#fff}
    .card{
      width:240px;background:#fff;border:1px solid var(--line);border-radius:12px;padding:10px;
      cursor:grab;box-shadow:0 1px 3px rgba(0,0,0,.06);user-select:none;position:relative;
    }
    .card:active{cursor:grabbing}
    .small{font-size:12px;color:var(--muted)}
    .pinBtn{
      position:absolute;top:8px;right:8px;border:1px solid var(--line);
      background:#fff;border-radius:10px;padding:6px 8px;font-size:12px;font-weight:700;cursor:pointer;
    }
    .pinned{outline:2px solid var(--okLine)}
    .pinned .pinBtn{background:var(--ok);border-color:var(--okLine)}

    .scoreBox{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin:10px 0 12px}
    .metric{background:var(--accent);color:#fff;border-radius:12px;padding:10px 12px}
    .metric span{display:block;font-size:12px;opacity:.85}
    .metric b{display:block;font-size:16px;margin-top:2px}

    .board{display:grid;grid-template-columns:repeat(4, 1fr);gap:12px}
    @media (max-width:1100px){.board{grid-template-columns:repeat(2, 1fr)}}
    @media (max-width:720px){.board{grid-template-columns:1fr}}
    .bucket{
      min-height:230px;border:2px dashed #cbd5e1;border-radius:14px;padding:10px;background:#f8fafc;
    }
    .bucket.dragover{border-color:var(--accent);background:#eef2ff}
    .bucketTitle{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
    .bucketTitle b{font-size:13px}
    .pill{font-size:12px;padding:4px 8px;border-radius:999px;background:#e5e7eb;color:var(--ink)}
    .bucketInner{display:flex;flex-wrap:wrap;gap:10px}
    .hint{font-size:12px;color:var(--muted)}

    .choices{display:grid;gap:8px;margin-top:10px}
    .choice{padding:10px 12px;border-radius:12px;border:1px solid var(--line);background:#fff;cursor:pointer}
    .choice.selected{outline:2px solid var(--accent)}
    .choice small{color:var(--muted)}

    .toast{margin-top:10px;padding:10px 12px;border-radius:12px;border:1px solid var(--line);background:#fff;display:none}

    .tinyNote{font-size:11px;color:var(--muted);margin-top:8px}
  </style>
</head>
<body>
<header>
  <div class="row">
    <h1>üîé RRL Detective: Evidence ‚Üí Tentative Answer ‚Üí Research Gap</h1>
    <div class="badge" id="timerBadge">
      ‚è±Ô∏è <b>Game:</b> <span class="mono" id="gameTimer">20:00</span>
      &nbsp;|&nbsp; <b>Twist:</b> <span class="mono" id="twistTimer">15:00</span>
    </div>
  </div>
</header>

<div class="container">
  <div class="grid cols">

    <!-- LEFT -->
    <div class="panel">
      <h2>1) Load a Case (Timer starts automatically)</h2>
      <p>Click once. The 20-minute timer starts as soon as the case loads.</p>

      <input id="teamName" type="text" placeholder="Team name (optional)" />
      <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:10px;">
        <button class="primary" id="randCaseBtn" onclick="assignRandomCase()">üé≤ Load Random Case (6 cases)</button>
        <button class="secondary" onclick="resetAll()">Reset</button>
      </div>
      <div class="tinyNote">Each case has <b>15 evidence cards</b>. Twist unlocks at <b>5:00 remaining</b>.</div>

      <div class="callout" style="margin-top:12px;">
        <b id="caseTitle">No case yet</b>
        <div class="small" id="caseSubtitle" style="margin-top:6px;">Load a case to begin.</div>
      </div>

      <div class="callout" style="margin-top:10px;">
        <b>Research Problem</b>
        <div class="small" id="problemText" style="margin-top:6px;">‚Äî</div>
      </div>

      <div class="callout" style="margin-top:10px;">
        <b>What your RRL must produce</b>
        <ul>
          <li>A <b>tentative answer</b> to the research problem (based on evidence patterns)</li>
          <li>A <b>research gap type</b>: theoretical, contextual, methodological (or combination)</li>
          <li>Pinned evidence that justifies your reasoning</li>
        </ul>
      </div>

      <div class="miniDef" style="margin-top:10px;">
        <b>Types of Research Gaps</b>

        <div class="def">
          <span class="tag">Theoretical gap</span>
          A theoretical gap exists when studies show patterns or relationships, but the explanation is unclear.
          The literature may answer ‚Äúwhat is happening‚Äù but not ‚Äúwhy or how it happens.‚Äù
          Look for missing mechanisms, missing concepts, or untested explanations.
        </div>

        <div class="def">
          <span class="tag">Contextual gap</span>
          A contextual gap exists when findings may not apply across populations, settings, or time periods.
          Look for ‚Äúit depends‚Äù evidence, missing comparisons (e.g., rural vs urban), or outdated data that may not fit today‚Äôs context.
        </div>

        <div class="def">
          <span class="tag">Methodological gap</span>
          A methodological gap exists when study designs or measurements limit confidence in conclusions.
          Look for cross-sectional surveys, weak measures, missing process data, missing comparison groups, or calls for stronger methods.
        </div>
      </div>

      <div class="twistBox" id="twistBox">
        <b>üö® Twist unlocked</b>
        <p class="small" id="twistText"></p>
        <button class="secondary" onclick="addTwistCards()">Add Twist Evidence</button>
      </div>

      <hr>

      <h2>2) Evidence Tray</h2>
      <p>Drag evidence into buckets. Cards can fit multiple interpretations. That‚Äôs normal in RRL.</p>
      <div class="evidenceTray" id="tray" ondragover="allowDrop(event)" ondrop="dropToTray(event)"></div>
      <p class="hint">Tip: Click <b>Pin</b> on a card to use it as evidence for your final answers.</p>
    </div>

    <!-- RIGHT -->
    <div class="panel">
      <h2>Evidence Sorting Board</h2>

      <div class="scoreBox">
        <div class="metric"><span>Score</span><b id="scoreNum">0</b></div>
        <div class="metric"><span>Cards Sorted</span><b id="sortedNum">0</b></div>
        <div class="metric"><span>Pinned Evidence</span><b id="pinnedNum">0</b></div>
      </div>

      <div class="board">
        <div class="bucket" ondragover="bucketOver(event)" ondragleave="bucketLeave(event)" ondrop="dropToBucket(event, 'claimA')">
          <div class="bucketTitle"><b>üìå Supports Claim A</b><span class="pill" id="countA">0</span></div>
          <div class="bucketInner" id="innerA"></div>
          <p class="hint" id="claimAText">Load a case to see Claim A.</p>
        </div>

        <div class="bucket" ondragover="bucketOver(event)" ondragleave="bucketLeave(event)" ondrop="dropToBucket(event, 'claimB')">
          <div class="bucketTitle"><b>üìå Supports Claim B</b><span class="pill" id="countB">0</span></div>
          <div class="bucketInner" id="innerB"></div>
          <p class="hint" id="claimBText">Load a case to see Claim B.</p>
        </div>

        <div class="bucket" ondragover="bucketOver(event)" ondragleave="bucketLeave(event)" ondrop="dropToBucket(event, 'boundary')">
          <div class="bucketTitle"><b>üß≠ Boundary / Context</b><span class="pill" id="countC">0</span></div>
          <div class="bucketInner" id="innerC"></div>
          <p class="hint">Evidence that explains ‚Äúit depends‚Äù (population, setting, time, conditions).</p>
        </div>

        <div class="bucket" ondragover="bucketOver(event)" ondragleave="bucketLeave(event)" ondrop="dropToBucket(event, 'methods')">
          <div class="bucketTitle"><b>üß™ Method / Measurement Limits</b><span class="pill" id="countM">0</span></div>
          <div class="bucketInner" id="innerM"></div>
          <p class="hint">Evidence showing design weaknesses (weak measures, missing comparisons, process gaps).</p>
        </div>
      </div>

      <hr>

      <h2>Final Outputs</h2>
      <p>Choose a tentative answer + gap type(s), then pin evidence to justify.</p>

      <h3>Tentative Answer</h3>
      <div class="choices" id="answerChoices"></div>

      <h3 style="margin-top:12px;">Gap Type(s)</h3>
      <div class="choices" id="gapChoices"></div>

      <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:12px;">
        <button class="primary" onclick="submit()" id="submitBtn" disabled>Submit</button>
        <button class="secondary" onclick="hint()">Hint</button>
      </div>

      <div id="result" class="toast"></div>
    </div>

  </div>
</div>

<script>
/** ========= Timing ========= */
const TOTAL_SECONDS = 20 * 60;
// Twist unlock at 5-minute remaining
const TWIST_UNLOCK_AT_REMAINING = 5 * 60;

let remaining = TOTAL_SECONDS;
let timer = null;
let started = false;

/** ========= State ========= */
let activeCase = null;
let twistUnlocked = false;
let twistAdded = false;
let answerPick = null;
let gapTypePicks = new Set();
let pinned = new Set();
let score = 0;

/** ========= Cases (6 cases, each with 15 evidence) =========
 * Evidence cards have:
 * roles: claimA, claimB, boundary, methods (for sorting)
 * gapHints: THEORETICAL, CONTEXTUAL, METHODOLOGICAL (for learning + gap selection)
 */
const CASES = [
  // 1) Social media & academic performance
  {
    id: "socialmedia",
    title: "Case 1: Social Media Use & Academic Performance",
    subtitle: "Advise a college: does social media harm academic performance?",
    problem: "Based on current studies, what is the most reasonable tentative answer about social media use and academic performance? What gap should a new study address?",
    claimA: "Claim A: More social media use is linked to lower academic performance.",
    claimB: "Claim B: Effects are conditional; outcomes depend on how social media is used and context.",
    answerKey: "MIXED_DEPENDS",
    gapKey: ["CONTEXTUAL","METHODOLOGICAL"],
    cards: [
      { id:"SM1",  title:"Study (College Survey)", text:"Higher daily use correlates with lower GPA.", roles:["claimA"], gapHints:["METHODOLOGICAL"], meta:["Cross-sectional correlation"] },
      { id:"SM2",  title:"Study (Time vs Purpose)", text:"Screen time predicts little unless purpose is specified.", roles:["methods"], gapHints:["METHODOLOGICAL"], meta:["Measure too broad"] },
      { id:"SM3",  title:"Study (Passive vs Active)", text:"Passive scrolling predicts poorer outcomes; active academic networking is neutral/positive.", roles:["claimB","boundary"], gapHints:["THEORETICAL","CONTEXTUAL"], meta:["Mechanism + boundary"] },
      { id:"SM4",  title:"Study (Different Platforms)", text:"Effects differ across platforms; short-video use shows stronger distraction signals.", roles:["boundary"], gapHints:["CONTEXTUAL"], meta:["Platform context"] },
      { id:"SM5",  title:"Study (Private Universities)", text:"No significant link found in private universities in one sample.", roles:["claimB","boundary"], gapHints:["CONTEXTUAL"], meta:["Setting-specific"] },
      { id:"SM6",  title:"Study (High School Samples)", text:"Many findings are from high school; transfer to college is unclear.", roles:["boundary"], gapHints:["CONTEXTUAL"], meta:["Population mismatch"] },
      { id:"SM7",  title:"Study (Sleep)", text:"Sleep disruption may mediate the relationship but is rarely tested directly.", roles:["methods"], gapHints:["THEORETICAL"], meta:["Mechanism not tested"] },
      { id:"SM8",  title:"Study (Attention)", text:"Attention and multitasking are proposed mechanisms, but measures are inconsistent.", roles:["methods"], gapHints:["THEORETICAL","METHODOLOGICAL"], meta:["Weak/varied measures"] },
      { id:"SM9",  title:"Study (Pandemic Shift)", text:"Usage patterns changed after remote learning; old findings may not hold.", roles:["boundary"], gapHints:["CONTEXTUAL"], meta:["Time/context shift"] },
      { id:"SM10", title:"Study (Self-report Bias)", text:"Most studies use self-reported screen time; reliability concerns.", roles:["methods"], gapHints:["METHODOLOGICAL"], meta:["Measurement validity"] },
      { id:"SM11", title:"Study (Academic Self-control)", text:"Self-control moderates effects; high self-control reduces negative outcomes.", roles:["claimB","boundary"], gapHints:["THEORETICAL","CONTEXTUAL"], meta:["Moderator"] },
      { id:"SM12", title:"Study (Time-on-task)", text:"Time-on-task decreases when notifications are frequent.", roles:["claimA"], gapHints:["THEORETICAL"], meta:["Mechanism clue"] },
      { id:"SM13", title:"Study (Mixed Findings)", text:"Across studies, effect sizes vary widely; some show near-zero effects.", roles:["claimB","boundary"], gapHints:["CONTEXTUAL"], meta:["Heterogeneity"] },
      { id:"SM14", title:"Study (Design Limitation)", text:"Most studies are one-time surveys; causality remains unclear.", roles:["methods"], gapHints:["METHODOLOGICAL"], meta:["Need stronger designs"] },
      { id:"SM15", title:"Study (Intervention)", text:"Notification reduction intervention improves focus in a small trial.", roles:["claimA","methods"], gapHints:["METHODOLOGICAL"], meta:["Small sample, limited generalizability"] },
    ],
    twist: {
      text: "New synthesis arrives: effects are strongly driven by engagement type and study quality.",
      cards: [
        { id:"TSM1", title:"Twist (Meta-analysis)", text:"Overall effects are small-to-moderate but highly variable by engagement type.", roles:["claimB","boundary"], gapHints:["CONTEXTUAL"], meta:["Heterogeneity evidence"] },
        { id:"TSM2", title:"Twist (Design Quality)", text:"Longitudinal designs show different patterns than cross-sectional surveys.", roles:["methods"], gapHints:["METHODOLOGICAL"], meta:["Design quality matters"] },
      ]
    }
  },

  // 2) Digital loan apps & inclusion
  {
    id: "digitalbank",
    title: "Case 2: Digital Loan Apps & Financial Inclusion",
    subtitle: "Evaluate whether digital loan applications exclude low-income households.",
    problem: "Are digital loan application processes financially inclusive for low-income households, or do they create barriers? What tentative answer fits the evidence pattern, and what gap remains?",
    claimA: "Claim A: Digital loan apps increase access for previously unbanked applicants.",
    claimB: "Claim B: Digital loan apps can exclude low-income users through process barriers (KYC, literacy, connectivity).",
    answerKey: "BOTH_TRUE_PROCESS_GAP",
    gapKey: ["METHODOLOGICAL","CONTEXTUAL"],
    cards: [
      { id:"DB1",  title:"Study (Access Benefit)", text:"Digital lending expands access among previously unbanked applicants.", roles:["claimA"], gapHints:["CONTEXTUAL"], meta:["Who benefits: unbanked"] },
      { id:"DB2",  title:"Study (KYC Drop-off)", text:"Large applicant drop-off occurs during document upload steps.", roles:["claimB","boundary"], gapHints:["METHODOLOGICAL"], meta:["Process bottleneck"] },
      { id:"DB3",  title:"Study (Digital Literacy)", text:"Lower digital literacy predicts incomplete applications.", roles:["claimB","boundary"], gapHints:["CONTEXTUAL"], meta:["Skill barrier"] },
      { id:"DB4",  title:"Study (Connectivity)", text:"Low connectivity users are less likely to finish onboarding.", roles:["claimB","boundary"], gapHints:["CONTEXTUAL"], meta:["Infrastructure barrier"] },
      { id:"DB5",  title:"Study (Outcome-only)", text:"Many studies report approval rates but not reasons for rejection/abandonment.", roles:["methods"], gapHints:["METHODOLOGICAL"], meta:["Missing process evidence"] },
      { id:"DB6",  title:"Study (Rural vs Urban Missing)", text:"Few studies compare rural and urban applicants for the same product.", roles:["methods","boundary"], gapHints:["CONTEXTUAL"], meta:["Context comparison missing"] },
      { id:"DB7",  title:"Study (Fees/Hidden Costs)", text:"Some users drop out due to perceived hidden fees or unclear terms.", roles:["claimB","boundary"], gapHints:["THEORETICAL","CONTEXTUAL"], meta:["Trust + comprehension"] },
      { id:"DB8",  title:"Study (Trust)", text:"Trust in fintech predicts completion; distrust increases abandonment.", roles:["claimB","boundary"], gapHints:["THEORETICAL"], meta:["Mechanism clue"] },
      { id:"DB9",  title:"Study (Alternative Channels)", text:"Agent-assisted onboarding improves completion in low-income segments.", roles:["claimA","boundary"], gapHints:["CONTEXTUAL"], meta:["Hybrid support"] },
      { id:"DB10", title:"Study (Bias Risk)", text:"Automated scoring may underpredict creditworthiness for informal workers.", roles:["claimB","methods"], gapHints:["METHODOLOGICAL","CONTEXTUAL"], meta:["Data bias"] },
      { id:"DB11", title:"Study (ID Requirement)", text:"Applicants without valid IDs cannot proceed, excluding some groups.", roles:["claimB","boundary"], gapHints:["CONTEXTUAL"], meta:["Policy constraint"] },
      { id:"DB12", title:"Study (Process Step Mapping)", text:"Few papers map the full user journey; evidence is fragmented.", roles:["methods"], gapHints:["METHODOLOGICAL"], meta:["Need process mapping"] },
      { id:"DB13", title:"Study (Financial Literacy)", text:"Lower financial literacy predicts higher confusion and drop-off.", roles:["claimB","boundary"], gapHints:["CONTEXTUAL"], meta:["Capability barrier"] },
      { id:"DB14", title:"Study (Mixed Outcome)", text:"Approval rates rise, but completion rates are uneven across income groups.", roles:["claimB","boundary"], gapHints:["CONTEXTUAL"], meta:["Unequal completion"] },
      { id:"DB15", title:"Study (Mechanism Gap)", text:"Few studies test how policy requirements interact with literacy and connectivity.", roles:["methods"], gapHints:["THEORETICAL"], meta:["Interaction mechanisms"] },
    ],
    twist: {
      text: "Policy update: stricter KYC increases abandonment among low-income applicants.",
      cards: [
        { id:"TDB1", title:"Twist (Policy Change)", text:"Stricter KYC correlates with higher abandonment among low-income users.", roles:["claimB","boundary"], gapHints:["CONTEXTUAL"], meta:["Policy-context interaction"] },
        { id:"TDB2", title:"Twist (Support Feature)", text:"In-app guided help reduces abandonment for low-literacy users.", roles:["claimA","boundary"], gapHints:["METHODOLOGICAL","CONTEXTUAL"], meta:["Intervention clue"] },
      ]
    }
  },

  // 3) Remote work & productivity
  {
    id: "remotework",
    title: "Case 3: Remote Work & Productivity",
    subtitle: "Does remote work increase or decrease productivity?",
    problem: "A manager asks whether remote work improves productivity. Based on studies, what tentative answer fits best, and what gap remains?",
    claimA: "Claim A: Remote work increases productivity.",
    claimB: "Claim B: Remote work does not consistently increase productivity; effects depend on role, support, and home context.",
    answerKey: "MIXED_DEPENDS",
    gapKey: ["CONTEXTUAL","METHODOLOGICAL"],
    cards: [
      { id:"RW1",  title:"Study (Output Metrics)", text:"Some teams show higher output after shifting remote.", roles:["claimA"], gapHints:["METHODOLOGICAL"], meta:["Output metric chosen"] },
      { id:"RW2",  title:"Study (Knowledge Work)", text:"Knowledge workers report better focus; results not generalizable to all roles.", roles:["claimB","boundary"], gapHints:["CONTEXTUAL"], meta:["Role specificity"] },
      { id:"RW3",  title:"Study (Collaboration)", text:"Collaboration quality declines without intentional coordination practices.", roles:["claimB","boundary"], gapHints:["THEORETICAL","CONTEXTUAL"], meta:["Coordination mechanism"] },
      { id:"RW4",  title:"Study (Home Setup)", text:"Productivity benefits appear only when home workspace is adequate.", roles:["claimB","boundary"], gapHints:["CONTEXTUAL"], meta:["Home environment"] },
      { id:"RW5",  title:"Study (Parenting Load)", text:"Care responsibilities reduce productivity for some groups.", roles:["claimB","boundary"], gapHints:["CONTEXTUAL"], meta:["Household context"] },
      { id:"RW6",  title:"Study (Self-report)", text:"Many studies rely on self-reported productivity.", roles:["methods"], gapHints:["METHODOLOGICAL"], meta:["Measurement bias"] },
      { id:"RW7",  title:"Study (Time Period)", text:"Pandemic lockdown studies may not represent normal remote work.", roles:["boundary"], gapHints:["CONTEXTUAL"], meta:["Exceptional conditions"] },
      { id:"RW8",  title:"Study (Manager Support)", text:"Supervisor support predicts better remote performance.", roles:["claimB","boundary"], gapHints:["THEORETICAL"], meta:["Resource mechanism"] },
      { id:"RW9",  title:"Study (Autonomy)", text:"Autonomy increases engagement; overly monitored remote workers do worse.", roles:["claimB","boundary"], gapHints:["THEORETICAL","CONTEXTUAL"], meta:["Control mechanism"] },
      { id:"RW10", title:"Study (Hybrid Comparison)", text:"Few studies compare remote vs hybrid vs onsite within the same firm.", roles:["methods"], gapHints:["METHODOLOGICAL"], meta:["Missing comparisons"] },
      { id:"RW11", title:"Study (Attrition)", text:"Remote arrangements reduce turnover intention for some employees.", roles:["claimA","boundary"], gapHints:["CONTEXTUAL"], meta:["Outcome differs by metric"] },
      { id:"RW12", title:"Study (Team Norms)", text:"Clear norms (core hours, response expectations) improve outcomes.", roles:["claimA","boundary"], gapHints:["THEORETICAL"], meta:["Mechanism: norms"] },
      { id:"RW13", title:"Study (Task Interdependence)", text:"Highly interdependent tasks face more coordination loss.", roles:["claimB","boundary"], gapHints:["CONTEXTUAL"], meta:["Task structure"] },
      { id:"RW14", title:"Study (Design Limitation)", text:"Causality is unclear; few randomized or quasi-experimental designs.", roles:["methods"], gapHints:["METHODOLOGICAL"], meta:["Need stronger designs"] },
      { id:"RW15", title:"Study (Equity)", text:"Remote benefits are uneven by job level and access to resources.", roles:["claimB","boundary"], gapHints:["CONTEXTUAL"], meta:["Unequal access"] },
    ],
    twist: {
      text: "New evidence: firms with strong coordination systems show sustained productivity gains.",
      cards: [
        { id:"TRW1", title:"Twist (System Effect)", text:"Coordination tools + clear routines predict better outcomes over time.", roles:["claimA","boundary"], gapHints:["THEORETICAL","CONTEXTUAL"], meta:["Boundary: systems"] },
        { id:"TRW2", title:"Twist (Longitudinal)", text:"Longitudinal data shows initial productivity spike may fade without support.", roles:["claimB","methods"], gapHints:["METHODOLOGICAL"], meta:["Time dynamics"] },
      ]
    }
  },

  // 4) AI tools & student learning
  {
    id: "ai_learning",
    title: "Case 4: AI Tools & Student Learning",
    subtitle: "Do AI tools improve learning, or reduce thinking effort?",
    problem: "A school wants guidance on allowing AI tools for assignments. Based on studies, what tentative answer fits, and what gap remains?",
    claimA: "Claim A: AI tools improve learning outcomes.",
    claimB: "Claim B: AI tools may reduce deep learning unless used with guidance; effects depend on how students use them.",
    answerKey: "MIXED_DEPENDS",
    gapKey: ["THEORETICAL","METHODOLOGICAL"],
    cards: [
      { id:"AI1",  title:"Study (Practice Support)", text:"AI tutoring increases practice frequency and short-term quiz scores.", roles:["claimA"], gapHints:["METHODOLOGICAL"], meta:["Short-term outcomes"] },
      { id:"AI2",  title:"Study (Surface Learning)", text:"Students copy AI answers; performance improves but understanding is unclear.", roles:["claimB","methods"], gapHints:["THEORETICAL","METHODOLOGICAL"], meta:["Mechanism unclear"] },
      { id:"AI3",  title:"Study (Prompting Skills)", text:"Students with better prompting produce better work.", roles:["boundary"], gapHints:["CONTEXTUAL"], meta:["Skill differences"] },
      { id:"AI4",  title:"Study (Metacognition)", text:"Few studies measure metacognition or self-regulation changes.", roles:["methods"], gapHints:["THEORETICAL"], meta:["Missing mechanisms"] },
      { id:"AI5",  title:"Study (Feedback Type)", text:"AI feedback helps when students revise; harms when students submit unchanged.", roles:["claimB","boundary"], gapHints:["THEORETICAL","CONTEXTUAL"], meta:["Use pattern"] },
      { id:"AI6",  title:"Study (Academic Integrity)", text:"Concerns rise; policing changes student behavior, affecting outcomes.", roles:["boundary"], gapHints:["CONTEXTUAL"], meta:["Policy context"] },
      { id:"AI7",  title:"Study (Long-term Retention)", text:"Long-term retention outcomes are rarely reported.", roles:["methods"], gapHints:["METHODOLOGICAL"], meta:["Missing long-term evidence"] },
      { id:"AI8",  title:"Study (Randomized Trial Small)", text:"Small trial shows gains, but sample is limited.", roles:["claimA","methods"], gapHints:["METHODOLOGICAL"], meta:["Low generalizability"] },
      { id:"AI9",  title:"Study (Teacher Scaffolding)", text:"Structured guidance leads to better learning than unrestricted use.", roles:["claimB","boundary"], gapHints:["THEORETICAL"], meta:["Mechanism: scaffolding"] },
      { id:"AI10", title:"Study (Equity)", text:"Students with less access/devices benefit less.", roles:["claimB","boundary"], gapHints:["CONTEXTUAL"], meta:["Access inequality"] },
      { id:"AI11", title:"Study (Cognitive Load)", text:"AI reduces cognitive load, but may reduce productive struggle.", roles:["claimB"], gapHints:["THEORETICAL"], meta:["Mechanism clue"] },
      { id:"AI12", title:"Study (Measurement Problem)", text:"Studies measure grades but not process (how students worked).", roles:["methods"], gapHints:["METHODOLOGICAL"], meta:["Process missing"] },
      { id:"AI13", title:"Study (Discipline Differences)", text:"Effects differ by discipline (writing vs math vs coding).", roles:["boundary"], gapHints:["CONTEXTUAL"], meta:["Domain boundary"] },
      { id:"AI14", title:"Study (Self-report Usage)", text:"Students underreport AI use; data quality concern.", roles:["methods"], gapHints:["METHODOLOGICAL"], meta:["Reporting bias"] },
      { id:"AI15", title:"Study (Mechanism Gap)", text:"Few studies test whether AI improves understanding or just performance.", roles:["methods"], gapHints:["THEORETICAL","METHODOLOGICAL"], meta:["Key mechanism unknown"] },
    ],
    twist: {
      text: "New evidence: guided AI use improves learning, unguided use increases shortcut behavior.",
      cards: [
        { id:"TAI1", title:"Twist (Guided vs Unguided)", text:"Guided use improves retention; unguided increases copying.", roles:["claimB","boundary"], gapHints:["THEORETICAL","METHODOLOGICAL"], meta:["Mechanism + design"] },
        { id:"TAI2", title:"Twist (Process Data)", text:"Log-data studies reveal different learning paths than surveys.", roles:["methods"], gapHints:["METHODOLOGICAL"], meta:["Better measurement"] },
      ]
    }
  },

  // 5) Hybrid work & well-being
  {
    id: "hybrid_wellbeing",
    title: "Case 5: Hybrid Work & Employee Well-being",
    subtitle: "Does hybrid work improve well-being, or create role strain?",
    problem: "An organization wants a policy on hybrid work. Based on studies, what tentative answer fits, and what gap remains?",
    claimA: "Claim A: Hybrid work improves well-being through flexibility and autonomy.",
    claimB: "Claim B: Hybrid work can increase role strain; well-being depends on job resources and home demands.",
    answerKey: "MIXED_DEPENDS",
    gapKey: ["THEORETICAL","CONTEXTUAL"],
    cards: [
      { id:"HW1",  title:"Study (Flexibility)", text:"Flexibility predicts higher well-being in multiple samples.", roles:["claimA"], gapHints:["THEORETICAL"], meta:["Resource clue"] },
      { id:"HW2",  title:"Study (Role Overload)", text:"Work-home boundary blurring predicts stress and burnout.", roles:["claimB"], gapHints:["THEORETICAL"], meta:["Mechanism clue"] },
      { id:"HW3",  title:"Study (Care Responsibilities)", text:"Care demands moderate outcomes; some groups report higher strain.", roles:["claimB","boundary"], gapHints:["CONTEXTUAL"], meta:["Family context"] },
      { id:"HW4",  title:"Study (Manager Support)", text:"Supportive leadership reduces strain and improves well-being.", roles:["claimB","boundary"], gapHints:["THEORETICAL"], meta:["Resource mechanism"] },
      { id:"HW5",  title:"Study (Isolation)", text:"Isolation increases for some remote-heavy hybrid schedules.", roles:["claimB","boundary"], gapHints:["CONTEXTUAL"], meta:["Schedule boundary"] },
      { id:"HW6",  title:"Study (Autonomy)", text:"Autonomy predicts engagement and satisfaction.", roles:["claimA"], gapHints:["THEORETICAL"], meta:["Mechanism clue"] },
      { id:"HW7",  title:"Study (Workload)", text:"High workload cancels out flexibility benefits.", roles:["claimB","boundary"], gapHints:["THEORETICAL","CONTEXTUAL"], meta:["Interaction"] },
      { id:"HW8",  title:"Study (Gendered Patterns)", text:"Unequal unpaid work shapes experiences; outcomes differ by household structure.", roles:["claimB","boundary"], gapHints:["CONTEXTUAL"], meta:["Population boundary"] },
      { id:"HW9",  title:"Study (Cross-sectional)", text:"Most well-being studies are cross-sectional; mechanisms remain uncertain.", roles:["methods"], gapHints:["METHODOLOGICAL"], meta:["Design limitation"] },
      { id:"HW10", title:"Study (Measurement)", text:"Well-being measures vary; comparability is limited.", roles:["methods"], gapHints:["METHODOLOGICAL"], meta:["Inconsistent measures"] },
      { id:"HW11", title:"Study (Policy Differences)", text:"Different hybrid policies across firms make comparisons difficult.", roles:["boundary"], gapHints:["CONTEXTUAL"], meta:["Policy context"] },
      { id:"HW12", title:"Study (Job Resources Quality)", text:"Quality of resources (support, control) matters more than presence.", roles:["claimB","methods"], gapHints:["THEORETICAL"], meta:["Quality mechanism"] },
      { id:"HW13", title:"Study (Boundary Strategies)", text:"Personal boundary strategies reduce conflict and improve well-being.", roles:["claimA","boundary"], gapHints:["THEORETICAL"], meta:["Mechanism clue"] },
      { id:"HW14", title:"Study (Sector Bias)", text:"Many samples are from education/tech; other sectors are under-studied.", roles:["boundary"], gapHints:["CONTEXTUAL"], meta:["Context missing"] },
      { id:"HW15", title:"Study (Longitudinal Lack)", text:"Few longitudinal studies track well-being over time.", roles:["methods"], gapHints:["METHODOLOGICAL"], meta:["Time dynamics missing"] },
    ],
    twist: {
      text: "New evidence: well-being improves only when job resources offset home demands.",
      cards: [
        { id:"THW1", title:"Twist (Resource Balance)", text:"High resources + manageable home demands predict thriving; otherwise strain grows.", roles:["claimB","boundary"], gapHints:["THEORETICAL","CONTEXTUAL"], meta:["Balance mechanism"] },
        { id:"THW2", title:"Twist (Schedule Design)", text:"2‚Äì3 office days works best for collaboration and well-being in one study.", roles:["claimA","boundary"], gapHints:["CONTEXTUAL"], meta:["Boundary condition"] },
      ]
    }
  },

  // 6) Sustainability practices in SMEs
  {
    id: "sme_sustainability",
    title: "Case 6: Sustainability Practices in SMEs",
    subtitle: "Do sustainability practices improve SME performance?",
    problem: "An SME association asks: do sustainability practices improve performance, and what is still missing in the evidence?",
    claimA: "Claim A: Sustainability practices improve SME performance and competitiveness.",
    claimB: "Claim B: Sustainability does not consistently improve performance; outcomes depend on implementation, context, and measurement quality.",
    answerKey: "MIXED_DEPENDS",
    gapKey: ["METHODOLOGICAL","CONTEXTUAL"],
    cards: [
      { id:"SS1",  title:"Study (Marketing Benefit)", text:"Green branding predicts higher customer preference in some markets.", roles:["claimA","boundary"], gapHints:["CONTEXTUAL"], meta:["Market context"] },
      { id:"SS2",  title:"Study (Cost Barrier)", text:"Upfront costs reduce adoption among resource-constrained SMEs.", roles:["claimB","boundary"], gapHints:["CONTEXTUAL"], meta:["Resource constraint"] },
      { id:"SS3",  title:"Study (Measurement Issue)", text:"Performance is measured differently across studies; comparisons are hard.", roles:["methods"], gapHints:["METHODOLOGICAL"], meta:["Inconsistent metrics"] },
      { id:"SS4",  title:"Study (Short-term vs Long-term)", text:"Short-term profits may dip; long-term gains are unclear due to limited follow-up.", roles:["claimB","methods"], gapHints:["METHODOLOGICAL"], meta:["Time horizon gap"] },
      { id:"SS5",  title:"Study (Regulatory Context)", text:"Stronger regulation increases benefits of sustainability investments.", roles:["claimB","boundary"], gapHints:["CONTEXTUAL"], meta:["Policy boundary"] },
      { id:"SS6",  title:"Study (Industry Differences)", text:"Effects differ by industry (food, retail, manufacturing).", roles:["boundary"], gapHints:["CONTEXTUAL"], meta:["Industry boundary"] },
      { id:"SS7",  title:"Study (Owner Values)", text:"Owner values predict adoption; mechanism rarely tested formally.", roles:["methods"], gapHints:["THEORETICAL"], meta:["Motivation mechanism"] },
      { id:"SS8",  title:"Study (Access to Finance)", text:"SMEs with financing access adopt more practices and show better outcomes.", roles:["claimA","boundary"], gapHints:["CONTEXTUAL"], meta:["Resource boundary"] },
      { id:"SS9",  title:"Study (Self-report Bias)", text:"Sustainability practices are often self-reported; greenwashing risk.", roles:["methods"], gapHints:["METHODOLOGICAL"], meta:["Validity concern"] },
      { id:"SS10", title:"Study (Causal Ambiguity)", text:"High-performing SMEs may adopt sustainability because they can, not vice versa.", roles:["methods"], gapHints:["METHODOLOGICAL"], meta:["Reverse causality"] },
      { id:"SS11", title:"Study (Supply Chain)", text:"Supply-chain pressure pushes adoption; outcomes depend on buyer requirements.", roles:["claimB","boundary"], gapHints:["CONTEXTUAL"], meta:["External pressure"] },
      { id:"SS12", title:"Study (Implementation Quality)", text:"Quality of implementation predicts outcomes more than number of practices.", roles:["claimB","methods"], gapHints:["THEORETICAL"], meta:["Quality mechanism"] },
      { id:"SS13", title:"Study (Customer Willingness)", text:"Willingness to pay varies; benefits depend on market segment.", roles:["boundary"], gapHints:["CONTEXTUAL"], meta:["Market boundary"] },
      { id:"SS14", title:"Study (Mixed Results)", text:"Across countries, results vary widely; local conditions matter.", roles:["claimB","boundary"], gapHints:["CONTEXTUAL"], meta:["Cross-country variation"] },
      { id:"SS15", title:"Study (Method Gap)", text:"Few studies use objective audits or longitudinal designs in SMEs.", roles:["methods"], gapHints:["METHODOLOGICAL"], meta:["Need stronger evidence"] },
    ],
    twist: {
      text: "New evidence: verified sustainability (audits) predicts performance better than self-reports.",
      cards: [
        { id:"TSS1", title:"Twist (Audit Evidence)", text:"Audited practices correlate with performance; self-reports show inflated effects.", roles:["methods"], gapHints:["METHODOLOGICAL"], meta:["Measurement quality"] },
        { id:"TSS2", title:"Twist (Context)", text:"Benefits are strongest in markets with clear eco-label recognition.", roles:["claimB","boundary"], gapHints:["CONTEXTUAL"], meta:["Market boundary"] },
      ]
    }
  }
];

/** ========= UI helpers ========= */
const el = (id)=>document.getElementById(id);
const fmt = (sec)=>`${String(Math.floor(sec/60)).padStart(2,"0")}:${String(sec%60).padStart(2,"0")}`;
function escapeHTML(str){ return (str||"").replace(/[&<>"']/g,m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;" }[m])); }

/** ========= Timer logic ========= */
function startTimerIfNeeded(){
  if (started) return;
  started = true;

  timer = setInterval(()=>{
    remaining -= 1;

    if (!twistUnlocked && remaining <= TWIST_UNLOCK_AT_REMAINING){
      unlockTwist();
    }
    if (remaining <= 0){
      remaining = 0;
      endGame();
    }
    updateTimers();
  }, 1000);

  updateTimers();
}
function updateTimers(){
  el("gameTimer").textContent = fmt(remaining);
  if (!twistUnlocked){
    const untilTwist = Math.max(remaining - TWIST_UNLOCK_AT_REMAINING, 0);
    el("twistTimer").textContent = fmt(untilTwist);
  } else {
    el("twistTimer").textContent = "UNLOCKED";
  }
}
function unlockTwist(){
  twistUnlocked = true;
  el("twistText").textContent = activeCase.twist.text;
  el("twistBox").classList.add("show");
  toast("üö® Twist unlocked. Add the new evidence and reconsider your tentative answer and gaps.");
}
function addTwistCards(){
  if (!twistUnlocked || twistAdded) return;
  activeCase.twist.cards.forEach(addCardToTray);
  twistAdded = true;
  toast("‚úÖ Twist evidence added.");
}
function endGame(){
  if (timer) clearInterval(timer);
  el("timerBadge").textContent = "‚è±Ô∏è Time is up. Submit now.";
  el("submitBtn").disabled = false;
  toast("‚è±Ô∏è Time is up. Submit your tentative answer + gap types with pinned evidence.");
}

/** ========= Case loading (randomized among 6) ========= */
function assignRandomCase(){
  if (started) { toast("‚ö†Ô∏è Game already started. Reset to load a new case."); return; }
  const idx = Math.floor(Math.random()*CASES.length);
  loadCase(CASES[idx].id);
}
function loadCase(caseId){
  activeCase = CASES.find(c=>c.id===caseId);

  // reset state
  twistUnlocked = false; twistAdded = false;
  answerPick = null; gapTypePicks = new Set();
  pinned = new Set(); score = 0;
  remaining = TOTAL_SECONDS;
  if (timer) clearInterval(timer);
  started = false;

  // render case info
  el("caseTitle").textContent = activeCase.title;
  el("caseSubtitle").textContent = activeCase.subtitle;
  el("problemText").textContent = activeCase.problem;
  el("claimAText").textContent = activeCase.claimA;
  el("claimBText").textContent = activeCase.claimB;

  // clear UI
  clearBoardAndTray();
  el("twistBox").classList.remove("show");

  // add initial evidence to tray
  activeCase.cards.forEach(addCardToTray);

  // render choices
  renderAnswerChoices();
  renderGapChoices();

  // enable submit once case is loaded
  el("submitBtn").disabled = false;

  // timer auto-start
  startTimerIfNeeded();
  toast(`‚úÖ Case loaded: ${escapeHTML(activeCase.title)}. Timer started.`);
}

/** ========= Evidence cards ========= */
function addCardToTray(card){
  if (el("card_"+card.id)) return;

  const div = document.createElement("div");
  div.className = "card";
  div.id = "card_"+card.id;
  div.draggable = true;
  div.ondragstart = (e)=> e.dataTransfer.setData("text/plain", card.id);

  const rolesText = card.roles.map(r=>{
    if (r==="claimA") return `<span class="tag">Supports A</span>`;
    if (r==="claimB") return `<span class="tag">Supports B</span>`;
    if (r==="boundary") return `<span class="tag">Boundary/Context</span>`;
    if (r==="methods") return `<span class="tag">Method/Measure</span>`;
    return "";
  }).join("");

  const gapsText = card.gapHints.map(g=>{
    if (g==="THEORETICAL") return `<span class="tag">Theoretical clue</span>`;
    if (g==="CONTEXTUAL") return `<span class="tag">Contextual clue</span>`;
    if (g==="METHODOLOGICAL") return `<span class="tag">Methodological clue</span>`;
    return "";
  }).join("");

  div.innerHTML = `
    <button class="pinBtn" onclick="togglePin('${card.id}')">Pin</button>
    <b>${escapeHTML(card.title)}</b>
    <div class="small" style="margin-top:6px;">${escapeHTML(card.text)}</div>
    <div style="margin-top:8px;">${rolesText}</div>
    <div style="margin-top:6px;">${gapsText}</div>
    <div class="small" style="margin-top:6px;">${(card.meta||[]).map(m=>`‚Ä¢ ${escapeHTML(m)}`).join("<br>")}</div>
  `;
  el("tray").appendChild(div);
  updateMetrics();
}

function togglePin(cardId){
  const node = el("card_"+cardId);
  if (!node) return;
  if (pinned.has(cardId)){
    pinned.delete(cardId);
    node.classList.remove("pinned");
  } else {
    pinned.add(cardId);
    node.classList.add("pinned");
  }
  updateMetrics();
}

/** ========= Drag & drop ========= */
function allowDrop(e){ e.preventDefault(); }
function bucketOver(e){ e.preventDefault(); e.currentTarget.classList.add("dragover"); }
function bucketLeave(e){ e.currentTarget.classList.remove("dragover"); }

function dropToTray(e){
  e.preventDefault();
  const id = e.dataTransfer.getData("text/plain");
  const cardEl = el("card_"+id);
  if (!cardEl) return;
  el("tray").appendChild(cardEl);
  updateCounts();
}
function dropToBucket(e, which){
  e.preventDefault();
  e.currentTarget.classList.remove("dragover");
  const id = e.dataTransfer.getData("text/plain");
  const cardEl = el("card_"+id);
  if (!cardEl) return;

  const dest = {claimA:el("innerA"),claimB:el("innerB"),boundary:el("innerC"),methods:el("innerM")}[which];
  dest.appendChild(cardEl);
  updateCounts();
}

function updateCounts(){
  el("countA").textContent = el("innerA").children.length;
  el("countB").textContent = el("innerB").children.length;
  el("countC").textContent = el("innerC").children.length;
  el("countM").textContent = el("innerM").children.length;
  updateMetrics();
}

/** ========= Final choices ========= */
function renderAnswerChoices(){
  const wrap = el("answerChoices");
  wrap.innerHTML = "";

  const options = [
    { id:"A_TRUE", label:"Claim A is mostly supported", desc:"Most evidence points to Claim A, with few boundary/method issues." },
    { id:"B_TRUE", label:"Claim B is mostly supported", desc:"Evidence suggests effects depend on conditions; Claim B is stronger." },
    { id:"MIXED_DEPENDS", label:"Mixed results, depends on context", desc:"Studies conflict; boundary/context explains differences." },
    { id:"INSUFFICIENT", label:"Evidence is insufficient for a clear conclusion", desc:"Too many method/measurement limitations to conclude confidently." },
    { id:"BOTH_TRUE_PROCESS_GAP", label:"Both can be true; the process determines outcomes", desc:"Benefits exist, but barriers/process can exclude certain groups." },
  ];

  options.forEach(o=>{
    const div = document.createElement("div");
    div.className = "choice";
    div.id = "ans_"+o.id;
    div.innerHTML = `<b>${escapeHTML(o.label)}</b><br><small>${escapeHTML(o.desc)}</small>`;
    div.onclick = ()=>pickAnswer(o.id);
    wrap.appendChild(div);
  });
}
function pickAnswer(id){
  answerPick = id;
  [...document.querySelectorAll("#answerChoices .choice")].forEach(x=>x.classList.remove("selected"));
  const node = el("ans_"+id);
  if (node) node.classList.add("selected");
  updateMetrics();
}

function renderGapChoices(){
  const wrap = el("gapChoices");
  wrap.innerHTML = "";

  const opts = [
    { id:"THEORETICAL", label:"Theoretical gap", desc:"Explanation is unclear (why/how). Mechanisms not tested." },
    { id:"CONTEXTUAL", label:"Contextual gap", desc:"Missing comparisons by population/setting/time (for whom/where/when)." },
    { id:"METHODOLOGICAL", label:"Methodological gap", desc:"Design/measurement limits confidence (how well we know)." },
  ];

  opts.forEach(o=>{
    const div = document.createElement("div");
    div.className = "choice";
    div.id = "gap_"+o.id;
    div.innerHTML = `<b>${escapeHTML(o.label)}</b><br><small>${escapeHTML(o.desc)}</small>`;
    div.onclick = ()=>toggleGapType(o.id);
    wrap.appendChild(div);
  });
}
function toggleGapType(id){
  if (gapTypePicks.has(id)){
    gapTypePicks.delete(id);
    el("gap_"+id).classList.remove("selected");
  } else {
    gapTypePicks.add(id);
    el("gap_"+id).classList.add("selected");
  }
  updateMetrics();
}

/** ========= Scoring + breakdown ========= */
function computeScoreBreakdown(){
  if (!activeCase){
    return { total:0, breakdownLines:[] };
  }

  let breakdown = [];
  let total = 0;

  // Evidence pins
  const pinScore = Math.min(pinned.size * 6, 36);
  total += pinScore;
  breakdown.push(`Evidence support: ${pinScore} points (Pinned ${pinned.size} evidence cards)`);

  // Answer alignment
  let answerScore = 0;
  if (answerPick){
    if (answerPick === activeCase.answerKey){
      answerScore = 30;
      breakdown.push(`Tentative answer: 30 points (Best-supported synthesis for this case)`);
    } else {
      answerScore = 12;
      breakdown.push(`Tentative answer: 12 points (Plausible, but not the strongest synthesis given the evidence pattern)`);
    }
  } else {
    breakdown.push(`Tentative answer: 0 points (No answer selected)`);
  }
  total += answerScore;

  // Gap alignment
  const key = new Set(activeCase.gapKey);
  let gapMatches = 0;
  gapTypePicks.forEach(g=>{ if (key.has(g)) gapMatches++; });
  const gapScore = gapMatches * 15;
  total += gapScore;
  breakdown.push(`Gap identification: ${gapScore} points (${gapMatches} strong gap type matches)`);

  // Coherence bonus based on how they used boundary/method buckets
  let coherenceBonus = 0;
  const boundaryCount = el("innerC").children.length;
  const methodCount = el("innerM").children.length;

  if (answerPick === "INSUFFICIENT"){
    coherenceBonus = Math.min(methodCount * 3, 15);
  }
  if (answerPick === "MIXED_DEPENDS"){
    coherenceBonus = Math.min(boundaryCount * 3, 15);
  }
  if (answerPick === "BOTH_TRUE_PROCESS_GAP"){
    coherenceBonus = Math.min(boundaryCount * 2, 10);
  }
  if (coherenceBonus > 0){
    breakdown.push(`Synthesis coherence bonus: ${coherenceBonus} points`);
    total += coherenceBonus;
  }

  // Twist bonus
  let twistBonus = 0;
  if (twistUnlocked){
    const pinnedTwist = [...pinned].some(id => id.startsWith("T"));
    if (pinnedTwist){
      twistBonus = 10;
      breakdown.push(`Twist integration bonus: 10 points (Pinned at least one twist card)`);
      total += twistBonus;
    }
  }

  return { total, breakdownLines: breakdown };
}

function computeScore(){
  return computeScoreBreakdown().total;
}

function updateMetrics(){
  const sorted = ["innerA","innerB","innerC","innerM"].reduce((acc,id)=> acc + el(id).children.length, 0);
  el("sortedNum").textContent = sorted;
  el("pinnedNum").textContent = pinned.size;

  score = computeScore();
  el("scoreNum").textContent = score;
}

/** ========= Submit ========= */
function submit(){
  if (!activeCase){ toast("‚ö†Ô∏è Load a case first."); return; }
  if (!answerPick){ toast("‚ö†Ô∏è Choose a tentative answer first."); return; }
  if (gapTypePicks.size === 0){ toast("‚ö†Ô∏è Select at least one gap type."); return; }
  if (pinned.size < 2){ toast("‚ö†Ô∏è Pin at least 2 evidence cards to support your answer."); return; }

  const team = (el("teamName").value||"").trim() || "Unnamed Team";
  const { total, breakdownLines } = computeScoreBreakdown();
  const code = makeCode(team, total);
  const gapList = [...gapTypePicks].join(", ");

  el("result").style.display = "block";
  el("result").innerHTML = `
    <b>‚úÖ Submission Complete</b><br>
    <div class="small" style="margin-top:6px;">
      <b>Team:</b> ${escapeHTML(team)}<br>
      <b>Case:</b> ${escapeHTML(activeCase.title)}<br>
      <b>Tentative answer:</b> ${escapeHTML(answerPick)}<br>
      <b>Gap type(s):</b> ${escapeHTML(gapList)}<br>
      <b>Pinned evidence:</b> ${escapeHTML([...pinned].join(", "))}<br>
      <b>Total Score:</b> ${total}<br><br>

      <b>Score Breakdown</b><br>
      ${breakdownLines.map(b=>`‚Ä¢ ${escapeHTML(b)}`).join("<br>")}<br><br>

      <b>Shareable Code:</b> <span class="mono">${code}</span><br>
      <span class="hint">Send this code (or screenshot) to your instructor.</span>
    </div>
  `;
  el("result").scrollIntoView({behavior:"smooth", block:"start"});
}

/** ========= Hint ========= */
function hint(){
  if (!activeCase){ toast("Hint: Load a random case."); return; }
  if (!answerPick){
    toast("Hint: Choose a tentative answer based on the overall pattern across studies. If findings differ, try 'Mixed results' or 'Both can be true'.");
    return;
  }
  if (gapTypePicks.size === 0){
    toast("Hint: Choose gap type(s). Why/how missing = theoretical. For whom/where/when missing = contextual. Weak design/measures = methodological.");
    return;
  }
  if (pinned.size < 2){
    toast("Hint: Pin your strongest evidence. If you can‚Äôt pin 2 strong cards, your claim may be weak.");
    return;
  }
  if (twistUnlocked && !twistAdded){
    toast("Hint: Twist is unlocked. Add twist evidence and consider updating your tentative answer and gap.");
    return;
  }
  toast("Hint: Improve score by aligning your synthesis to the overall evidence pattern and selecting the most fitting gap type(s).");
}

/** ========= Reset ========= */
function clearBoardAndTray(){
  ["tray","innerA","innerB","innerC","innerM"].forEach(id=> el(id).innerHTML = "");
  el("countA").textContent = "0";
  el("countB").textContent = "0";
  el("countC").textContent = "0";
  el("countM").textContent = "0";
  el("result").style.display = "none";
  el("result").innerHTML = "";
  updateMetrics();
}
function resetAll(){
  if (timer) clearInterval(timer);
  location.reload();
}

/** ========= Toast ========= */
function toast(html){
  const t = el("result");
  t.style.display = "block";
  t.innerHTML = html;
  t.scrollIntoView({behavior:"smooth", block:"start"});
}

/** ========= Shareable code ========= */
function makeCode(team, total){
  const base = `${team}|${activeCase.id}|${total}|${Date.now()}`;
  let hash = 0;
  for (let i=0;i<base.length;i++){ hash = (hash*31 + base.charCodeAt(i)) >>> 0; }
  return `${activeCase.id.toUpperCase()}-${total}-${String(hash).slice(0,6)}`;
}

/** ========= Initial timer display ========= */
el("gameTimer").textContent = fmt(remaining);
// time until twist (20:00 - 5:00 = 15:00)
el("twistTimer").textContent = fmt(TOTAL_SECONDS - TWIST_UNLOCK_AT_REMAINING);
</script>
</body>
</html>
