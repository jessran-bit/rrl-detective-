<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>RRL Detective: Research Crime Scene</title>
  <style>
    :root { --bg:#f4f6f9; --card:#fff; --ink:#111827; --muted:#6b7280; --line:#e5e7eb; --warn:#fffbeb; --warnLine:#f59e0b; }
    * { box-sizing:border-box; }
    body { margin:0; font-family: Arial, sans-serif; background:var(--bg); color:var(--ink); }
    header { background:#111827; color:#fff; padding:14px 18px; position:sticky; top:0; z-index:10; }
    header .row { display:flex; gap:12px; align-items:center; justify-content:space-between; flex-wrap:wrap; }
    h1 { margin:0; font-size:18px; }
    .badge { display:inline-flex; align-items:center; gap:8px; padding:8px 12px; border-radius:999px; background:rgba(255,255,255,.12); }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }

    .container { max-width: 1200px; margin: 0 auto; padding: 16px; }
    .grid { display:grid; gap:12px; }
    .grid.cols { grid-template-columns: 380px 1fr; }
    @media (max-width: 980px){ .grid.cols{ grid-template-columns: 1fr; } }

    .panel { background:var(--card); border:1px solid var(--line); border-radius:14px; padding:14px; box-shadow: 0 1px 4px rgba(0,0,0,.06); }
    h2 { margin:0 0 10px; font-size:16px; }
    h3 { margin:0 0 8px; font-size:14px; }
    p { margin:8px 0; color:var(--muted); font-size:13px; line-height:1.45; }

    .controls { display:flex; flex-wrap:wrap; gap:10px; align-items:center; }
    input[type="text"]{ padding:10px 12px; border:1px solid var(--line); border-radius:10px; width:240px; }

    button { border:0; border-radius:10px; padding:10px 12px; cursor:pointer; font-weight:700; }
    button.primary { background:#111827; color:#fff; }
    button.secondary { background:#e5e7eb; color:#111827; }
    button.ghost { background:transparent; border:1px solid rgba(255,255,255,.25); color:#fff; }
    button:disabled { opacity:.55; cursor:not-allowed; }

    .callout {
      border:1px solid var(--line);
      border-left: 6px solid #111827;
      border-radius:12px;
      padding:10px 12px;
      background:#fff;
    }
    .callout b { font-size:13px; }
    .callout ul { margin:8px 0 0; padding-left:18px; color:var(--muted); font-size:13px; }
    .callout li { margin:4px 0; }

    .twistBox { display:none; margin-top:10px; border:1px solid var(--warnLine); background:var(--warn); padding:10px 12px; border-radius:12px; }
    .twistBox.show { display:block; }

    .folders { display:flex; gap:10px; flex-wrap:wrap; margin-top:10px; }
    .folder { flex:1; min-width: 200px; border:1px dashed #cbd5e1; padding:10px; border-radius:12px; background:#f8fafc; }
    .folderHead { display:flex; align-items:center; justify-content:space-between; gap:8px; }
    .folderHead b { font-size:13px; }
    .pill { font-size:12px; padding:4px 8px; border-radius:999px; background:#e5e7eb; color:#111827; }

    .evidenceTray { min-height: 120px; display:flex; flex-wrap:wrap; gap:10px; padding:10px; border:1px solid var(--line); border-radius:12px; background:#fff; }
    .card {
      width: 230px;
      background:#fff;
      border:1px solid var(--line);
      border-radius:12px;
      padding:10px;
      cursor:grab;
      box-shadow: 0 1px 3px rgba(0,0,0,.06);
      user-select:none;
    }
    .card:active { cursor:grabbing; }
    .small { font-size:12px; color:var(--muted); }
    .tagRow { display:flex; gap:6px; flex-wrap:wrap; margin-top:8px; }
    .tag { font-size:11px; padding:3px 7px; border-radius:999px; background:#f3f4f6; color:#111827; }

    .scoreBox { display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin:10px 0 12px; }
    .metric { background:#111827; color:#fff; border-radius:12px; padding:10px 12px; }
    .metric span { display:block; font-size:12px; opacity:.85; }
    .metric b { display:block; font-size:16px; margin-top:2px; }

    .board { display:grid; grid-template-columns: repeat(3, 1fr); gap:12px; }
    @media (max-width: 980px){ .board{ grid-template-columns: 1fr; } }
    .bucket {
      min-height: 230px;
      border:2px dashed #cbd5e1;
      border-radius:14px;
      padding:10px;
      background:#f8fafc;
    }
    .bucket.dragover { border-color:#111827; background:#eef2ff; }
    .bucketTitle { display:flex; align-items:center; justify-content:space-between; margin-bottom:8px; }
    .bucketTitle b { font-size:13px; }
    .bucketInner { display:flex; flex-wrap:wrap; gap:10px; }
    .hint { font-size:12px; color:var(--muted); }

    .choices { display:grid; gap:8px; margin-top:10px; }
    .choice {
      padding:10px 12px; border-radius:12px; border:1px solid var(--line);
      background:#fff; cursor:pointer;
    }
    .choice.selected { outline: 2px solid #111827; }
    .choice small { color:var(--muted); }

    .toast { margin-top:10px; padding:10px 12px; border-radius:12px; border:1px solid var(--line); background:#fff; display:none; }
    hr { border:none;border-top:1px solid var(--line); margin:14px 0; }
  </style>
</head>
<body>
<header>
  <div class="row">
    <h1>üîé RRL Detective: Research Crime Scene</h1>
    <div class="controls">
      <div class="badge" id="timerBadge">
        ‚è±Ô∏è Game: <span class="mono" id="gameTimer">20:00</span> |
        Twist: <span class="mono" id="twistTimer">10:00</span>
      </div>
      <button class="ghost" id="startBtn" onclick="startGame()">Start</button>
      <button class="ghost" onclick="resetAll()">Reset</button>
    </div>
  </div>
</header>

<div class="container">
  <div class="grid cols">
    <!-- LEFT -->
    <div class="panel">
      <h2>1) Team + Random Case</h2>
      <p>Click to get a case (random). This mirrors how RRL starts: you begin with a <b>research problem</b>, then gather evidence.</p>

      <input id="teamName" type="text" placeholder="Team name (optional)" />

      <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:10px;">
        <button class="primary" id="randCaseBtn" onclick="assignRandomCase()">üé≤ Get Random Case</button>
        <button class="secondary" id="changeCaseBtn" onclick="forceChangeCase()" disabled>Change Case (disabled)</button>
      </div>

      <div class="callout" style="margin-top:12px;">
        <b id="caseTitle">No case yet</b>
        <div class="small" id="caseSubtitle" style="margin-top:6px;">Click ‚ÄúGet Random Case‚Äù to begin.</div>
      </div>

      <div class="callout" style="margin-top:10px;">
        <b>Research Problem (What you are trying to answer)</b>
        <div class="small" id="problemText" style="margin-top:6px;">‚Äî</div>
      </div>

      <div class="callout" style="margin-top:10px;">
        <b>What to look for (RRL skills)</b>
        <ul id="lookForList"></ul>
      </div>

      <div class="twistBox" id="twistBox">
        <b>üö® Twist Unlocked (10-minute mark)</b>
        <p class="small" id="twistText"></p>
        <button class="secondary" onclick="addTwistCards()">Add Twist Evidence</button>
      </div>

      <hr>

      <h2>2) Evidence Folders</h2>
      <p>Click folders to open evidence. Drag cards into the board buckets.</p>
      <div class="folders" id="folders"></div>

      <hr>

      <h2>3) Evidence Tray</h2>
      <div class="evidenceTray" id="tray" ondragover="allowDrop(event)" ondrop="dropToTray(event)"></div>
      <p class="hint">Undo: drag any card back to the tray.</p>
    </div>

    <!-- RIGHT -->
    <div class="panel">
      <h2>Investigation Board</h2>

      <div class="scoreBox">
        <div class="metric"><span>Score</span><b id="scoreNum">0</b></div>
        <div class="metric"><span>Cards Sorted</span><b id="sortedNum">0</b></div>
        <div class="metric"><span>Gap Pick</span><b id="gapPick">None</b></div>
      </div>

      <div class="board">
        <div class="bucket" id="bucketThemes" ondragover="bucketOver(event)" ondragleave="bucketLeave(event)" ondrop="dropToBucket(event, 'themes')">
          <div class="bucketTitle"><b>‚úÖ Themes / What we know</b><span class="pill" id="countThemes">0</span></div>
          <div class="bucketInner" id="innerThemes"></div>
          <p class="hint">Common findings or repeated patterns.</p>
        </div>

        <div class="bucket" id="bucketContradictions" ondragover="bucketOver(event)" ondragleave="bucketLeave(event)" ondrop="dropToBucket(event, 'contradictions')">
          <div class="bucketTitle"><b>‚ö†Ô∏è Contradictions / Mixed results</b><span class="pill" id="countContradictions">0</span></div>
          <div class="bucketInner" id="innerContradictions"></div>
          <p class="hint">Conflicts, context differences, or ‚Äúdepends on‚Ä¶‚Äù evidence.</p>
        </div>

        <div class="bucket" id="bucketGaps" ondragover="bucketOver(event)" ondragleave="bucketLeave(event)" ondrop="dropToBucket(event, 'gaps')">
          <div class="bucketTitle"><b>üï≥Ô∏è Gap Clues / Missing evidence</b><span class="pill" id="countGaps">0</span></div>
          <div class="bucketInner" id="innerGaps"></div>
          <p class="hint">Missing population, method, time period, measures, mechanisms.</p>
        </div>
      </div>

      <hr>

      <h2>Gap Pick (Click Only)</h2>
      <p>After sorting evidence, pick the best research gap statement.</p>
      <div class="choices" id="choices"></div>

      <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:12px;">
        <button class="primary" id="submitBtn" onclick="submit()" disabled>Submit</button>
        <button class="secondary" onclick="autoHint()">Hint</button>
      </div>

      <div id="result" class="toast"></div>
    </div>
  </div>
</div>

<script>
/** =========================
 * GAME RULES
 * - Total time: 20:00
 * - Twist unlock: 10:00 mark (i.e., after 10 minutes elapsed)
 * ========================= */
const TOTAL_SECONDS = 20 * 60;
const TWIST_UNLOCK_AT_REMAINING = 10 * 60; // when remaining hits 10:00, twist unlocks

/** -------------------------
 * CASE DATA: now includes PROBLEM + LOOK-FOR guidance
 * ------------------------- */
const CASES = [
  {
    id: "socialmedia",
    title: "Case: Social Media & Academic Performance",
    subtitle: "A school committee wants evidence-based guidance for students.",
    problem: "You are asked to propose a research direction: What does the literature really say about social media use and academic performance, and what is still missing that a new study should address?",
    lookFor: [
      "Patterns: do studies agree on the direction (positive/negative/no effect)?",
      "Conditions: when does the effect change (type of use, context, population)?",
      "Limitations: are studies outdated or weak in design (cross-sectional only)?",
      "Missing evidence: what has not been tested or compared properly?",
      "Gap output: a specific gap, not a generic 'limited research' statement."
    ],
    folders: [
      { id:"F1", name:"Folder A: Core Findings", cards: [
        { id:"A1", title:"Study A (Survey)", text:"500 college students: heavy social media use linked to lower GPA.", tags:["contradiction"], meta:["College sample","Survey"] },
        { id:"A2", title:"Study B (Context)", text:"No significant link, but sample is private universities only.", tags:["contradiction","gap"], meta:["Private-only context","Generalizability issue"] },
        { id:"A3", title:"Study C (Usage Type)", text:"Passive scrolling harms performance more than active use.", tags:["theme","gap"], meta:["Type matters","Mechanism clue"] },
      ]},
      { id:"F2", name:"Folder B: Different Angles", cards: [
        { id:"B1", title:"Study D (Positive Pathway)", text:"Active academic networking on social media can improve grades.", tags:["contradiction","gap"], meta:["Active use differs","Moderation clue"] },
        { id:"B2", title:"Study E (Population)", text:"High school students only; findings may not apply to college.", tags:["gap"], meta:["Population mismatch"] },
        { id:"B3", title:"Study F (Old Data)", text:"2012 dataset. Before current platforms & post-pandemic habits.", tags:["gap"], meta:["Outdated time period"] },
      ]},
      { id:"F3", name:"Folder C: Methods & Measures", cards: [
        { id:"C1", title:"Method Note", text:"Most studies are cross-sectional (one-time surveys).", tags:["gap"], meta:["Design limitation","No causality"] },
        { id:"C2", title:"Measure Note", text:"Many studies measure 'screen time' only, not engagement type.", tags:["gap"], meta:["Measurement gap"] },
      ]},
    ],
    twist: {
      text: "New evidence: A 2024 meta-analysis shows mixed effects depending on passive vs active use and context; it recommends stronger designs for causal inference.",
      cards: [
        { id:"T1", title:"Twist (Meta-analysis 2024)", text:"Effects vary by passive vs active engagement and context.", tags:["contradiction","gap"], meta:["Synthesis evidence"] },
        { id:"T2", title:"Twist (Design Recommendation)", text:"Calls for longitudinal/experimental designs to test causality.", tags:["gap"], meta:["Design gap reinforced"] }
      ]
    },
    gapChoices: [
      { id:"G1", label:"Weak Gap", text:"There is limited research on social media and academic performance.", best:false },
      { id:"G2", label:"Strong Gap (specific + design)", text:"Findings are mixed partly because many studies do not distinguish passive vs active use and rely on cross-sectional surveys; updated post-pandemic, stronger designs (e.g., longitudinal) are needed.", best:true },
      { id:"G3", label:"So-so Gap", text:"More research is needed on college students in the Philippines.", best:false },
      { id:"G4", label:"Strong Gap (measurement + context)", text:"The gap is how engagement type (not just time spent) relates to academic outcomes across different contexts (e.g., public vs private) using consistent measures.", best:true }
    ]
  },

  {
    id: "digitalbank",
    title: "Case: Digital Loan Applications & Financial Inclusion",
    subtitle: "A development group wants to know if digital loan apps exclude low-income applicants.",
    problem: "You are asked to recommend a research direction: Are digital loan application processes financially inclusive for low-income households, or do they create barriers? What specific evidence is missing to answer this properly?",
    lookFor: [
      "Evidence of inclusion vs exclusion (mixed outcomes).",
      "Where barriers occur in the process (steps where people drop off).",
      "Who is excluded (income, literacy, rural/urban).",
      "What is not measured (reasons for drop-off/rejection).",
      "Gap output: a gap that points to process-level evidence and comparisons."
    ],
    folders: [
      { id:"F1", name:"Folder A: Process Barriers", cards: [
        { id:"A1", title:"Study A (UX barrier)", text:"KYC steps and document uploads exclude low-connectivity users.", tags:["theme","gap"], meta:["Barrier: connectivity","KYC friction"] },
        { id:"A2", title:"Study B (Positive access)", text:"Digital loans can increase access for previously unbanked users.", tags:["contradiction"], meta:["Inclusion benefit"] },
      ]},
      { id:"F2", name:"Folder B: Who Gets Left Out?", cards: [
        { id:"B1", title:"Study C (Income)", text:"Lower-income users show higher drop-off during onboarding.", tags:["theme","gap"], meta:["Income-linked barrier"] },
        { id:"B2", title:"Study D (Literacy)", text:"Low digital literacy predicts failure to complete applications.", tags:["theme","gap"], meta:["Skills barrier"] },
      ]},
      { id:"F3", name:"Folder C: Research Limits", cards: [
        { id:"C1", title:"Method Note", text:"Most studies report approval rates but not where/why users abandon.", tags:["gap"], meta:["Missing process-level evidence"] },
        { id:"C2", title:"Equity Note", text:"Few studies compare rural vs urban applicants for same product.", tags:["gap"], meta:["Context comparison missing"] },
      ]},
    ],
    twist: {
      text: "New evidence: Stricter KYC policy update increases abandonment among low-income users. This strengthens the need to study how policy interacts with literacy/connectivity.",
      cards: [
        { id:"T1", title:"Twist (Policy Update)", text:"Stricter KYC increases abandonment among low-income users.", tags:["theme","gap"], meta:["New structural constraint"] }
      ]
    },
    gapChoices: [
      { id:"G1", label:"Weak Gap", text:"There is limited research on digital loans.", best:false },
      { id:"G2", label:"Strong Gap (process-level)", text:"Most studies focus on outcomes (approval) but lack process-level evidence on where/why low-income users drop out; comparisons across contexts (rural/urban, connectivity levels) are missing.", best:true },
      { id:"G3", label:"So-so Gap", text:"More research is needed on digital banking in general.", best:false },
      { id:"G4", label:"Strong Gap (policy + equity)", text:"The gap is how KYC policy requirements interact with literacy and connectivity to create unequal access across rural vs urban applicants.", best:true }
    ]
  }
];

/** -------------------------
 * STATE
 * ------------------------- */
let activeCase = null;
let started = false;
let remaining = TOTAL_SECONDS;
let timer = null;
let twistUnlocked = false;
let twistAdded = false;

let selectedGap = null;
let score = 0;
let caseAssigned = false;

/** -------------------------
 * UI ELEMENTS
 * ------------------------- */
const el = (id) => document.getElementById(id);

function initUI(){
  updateTimersUI();
  clearBoardAndTray();
  renderEmptyFolders();
  renderEmptyChoices();
}
initUI();

/** -------------------------
 * RANDOM CASE ASSIGNMENT
 * ------------------------- */
function assignRandomCase(){
  if (caseAssigned) return;

  const idx = Math.floor(Math.random() * CASES.length);
  setCase(CASES[idx].id);

  caseAssigned = true;
  el("randCaseBtn").disabled = true;
  el("changeCaseBtn").disabled = true; // kept disabled per your request (avoid reroll)
  el("submitBtn").disabled = false; // allow submit once they work

  // Encourage start
  if (!started){
    showToast("‚úÖ Case assigned. Click <b>Start</b> to begin the 20-minute timer.");
  }
}

function forceChangeCase(){
  // intentionally disabled in this version
}

function setCase(caseId){
  activeCase = CASES.find(c => c.id === caseId);

  // Populate case guidance
  el("caseTitle").textContent = activeCase.title;
  el("caseSubtitle").textContent = activeCase.subtitle;
  el("problemText").textContent = activeCase.problem;

  const ul = el("lookForList");
  ul.innerHTML = "";
  activeCase.lookFor.forEach(item => {
    const li = document.createElement("li");
    li.textContent = item;
    ul.appendChild(li);
  });

  // Reset game elements for new case
  clearBoardAndTray();
  renderFolders();
  renderChoices();
  hideTwistBox();
  twistUnlocked = false;
  twistAdded = false;
  selectedGap = null;
  score = 0;
  updateMetrics();
}

/** -------------------------
 * FOLDERS + EVIDENCE
 * ------------------------- */
function renderEmptyFolders(){
  el("folders").innerHTML = `<div class="small">No case yet. Click ‚ÄúGet Random Case‚Äù.</div>`;
}
function renderFolders(){
  const folders = el("folders");
  folders.innerHTML = "";
  activeCase.folders.forEach(f => {
    const box = document.createElement("div");
    box.className = "folder";

    const head = document.createElement("div");
    head.className = "folderHead";

    const left = document.createElement("div");
    left.innerHTML = `<b>üìÅ ${escapeHTML(f.name)}</b><div class="small">${f.cards.length} evidence cards</div>`;

    const pill = document.createElement("span");
    pill.className = "pill";
    pill.textContent = "Open";

    head.appendChild(left);
    head.appendChild(pill);

    const btn = document.createElement("button");
    btn.className = "secondary";
    btn.textContent = "Open Folder";
    btn.style.marginTop = "10px";
    btn.onclick = () => openFolder(f.id);

    box.appendChild(head);
    box.appendChild(btn);
    folders.appendChild(box);
  });
}

function openFolder(folderId){
  const folder = activeCase.folders.find(f => f.id === folderId);
  folder.cards.forEach(card => addCardToTray(card));
}

function addCardToTray(card){
  if (el("card_" + card.id)) return;

  const div = document.createElement("div");
  div.className = "card";
  div.id = "card_" + card.id;
  div.draggable = true;
  div.ondragstart = (e) => dragStart(e, card.id);

  div.innerHTML = `
    <b>${escapeHTML(card.title)}</b>
    <div class="small" style="margin-top:6px;">${escapeHTML(card.text)}</div>
    <div class="tagRow">${(card.meta||[]).map(m => `<span class="tag">${escapeHTML(m)}</span>`).join("")}</div>
  `;
  el("tray").appendChild(div);
  updateMetrics();
}

/** -------------------------
 * DRAG/DROP
 * ------------------------- */
function dragStart(e, cardId){ e.dataTransfer.setData("text/plain", cardId); }
function allowDrop(e){ e.preventDefault(); }

function bucketOver(e){ e.preventDefault(); e.currentTarget.classList.add("dragover"); }
function bucketLeave(e){ e.currentTarget.classList.remove("dragover"); }

function dropToTray(e){
  e.preventDefault();
  const id = e.dataTransfer.getData("text/plain");
  const cardEl = el("card_" + id);
  if (!cardEl) return;
  el("tray").appendChild(cardEl);
  updateCountsAndScore();
}

function dropToBucket(e, bucket){
  e.preventDefault();
  e.currentTarget.classList.remove("dragover");
  const id = e.dataTransfer.getData("text/plain");
  const cardEl = el("card_" + id);
  if (!cardEl) return;

  const inner = {
    themes: el("innerThemes"),
    contradictions: el("innerContradictions"),
    gaps: el("innerGaps")
  }[bucket];

  inner.appendChild(cardEl);
  updateCountsAndScore();
}

function buildTagMap(){
  const map = {};
  const allCards = [];
  activeCase.folders.forEach(f => allCards.push(...f.cards));
  if (twistAdded) allCards.push(...activeCase.twist.cards);

  allCards.forEach(c => {
    const t = [];
    if (c.tags.includes("theme")) t.push("themes");
    if (c.tags.includes("contradiction")) t.push("contradictions");
    if (c.tags.includes("gap")) t.push("gaps");
    map[c.id] = t;
  });
  return map;
}

function updateCountsAndScore(){
  const ctThemes = el("innerThemes").children.length;
  const ctContr = el("innerContradictions").children.length;
  const ctGaps = el("innerGaps").children.length;

  el("countThemes").textContent = ctThemes;
  el("countContradictions").textContent = ctContr;
  el("countGaps").textContent = ctGaps;

  score = 0;
  const tagMap = buildTagMap();
  const placements = [
    ["themes","innerThemes"],
    ["contradictions","innerContradictions"],
    ["gaps","innerGaps"]
  ];

  placements.forEach(([bucket, innerId]) => {
    const inner = el(innerId);
    [...inner.children].forEach(node => {
      const cid = node.id.replace("card_","");
      const tags = tagMap[cid] || [];
      if (tags.includes(bucket)) score += 10;
    });
  });

  updateMetrics();
}

/** -------------------------
 * GAP CHOICES (click-only)
 * ------------------------- */
function renderEmptyChoices(){
  el("choices").innerHTML = `<div class="small">No case yet. Get a random case first.</div>`;
}
function renderChoices(){
  const choices = el("choices");
  choices.innerHTML = "";
  activeCase.gapChoices.forEach(ch => {
    const div = document.createElement("div");
    div.className = "choice";
    div.id = "choice_" + ch.id;
    div.innerHTML = `<b>${escapeHTML(ch.label)}</b><br><small>${escapeHTML(ch.text)}</small>`;
    div.onclick = () => pickGap(ch.id);
    choices.appendChild(div);
  });
}
function pickGap(id){
  selectedGap = id;
  document.querySelectorAll(".choice").forEach(c => c.classList.remove("selected"));
  el("choice_" + id).classList.add("selected");
  updateMetrics();
}

/** -------------------------
 * TIMERS: 20-min game, twist at 10-min mark
 * ------------------------- */
function startGame(){
  if (started) return;
  if (!activeCase){
    showToast("‚ö†Ô∏è Please click <b>Get Random Case</b> first.");
    return;
  }

  started = true;
  el("startBtn").disabled = true;

  timer = setInterval(() => {
    remaining -= 1;

    // Twist unlock when remaining hits 10:00
    if (!twistUnlocked && remaining <= TWIST_UNLOCK_AT_REMAINING){
      unlockTwist();
    }

    if (remaining <= 0){
      remaining = 0;
      endGame();
    }

    updateTimersUI();
  }, 1000);

  showToast("‚è±Ô∏è Game started. You have 20 minutes. Twist unlocks at 10-minute mark.");
  updateTimersUI();
}

function updateTimersUI(){
  // Game timer
  el("gameTimer").textContent = fmt(remaining);

  // Twist timer display
  if (!twistUnlocked){
    const untilTwist = Math.max(remaining - TWIST_UNLOCK_AT_REMAINING, 0);
    el("twistTimer").textContent = fmt(untilTwist);
  } else {
    el("twistTimer").textContent = "UNLOCKED";
  }
}

function unlockTwist(){
  twistUnlocked = true;
  el("twistText").textContent = activeCase.twist.text;
  el("twistBox").classList.add("show");
  showToast("üö® Twist unlocked! Add new evidence and adjust your synthesis.");
}

function addTwistCards(){
  if (!twistUnlocked || twistAdded) return;
  activeCase.twist.cards.forEach(c => addCardToTray(c));
  twistAdded = true;
  showToast("‚úÖ Twist evidence added to tray.");
}

function hideTwistBox(){
  el("twistBox").classList.remove("show");
}

function endGame(){
  if (timer) clearInterval(timer);
  el("timerBadge").textContent = "‚è±Ô∏è Time is up! Submit now.";
  el("submitBtn").disabled = false;
  showToast("‚è±Ô∏è Time is up. Click <b>Submit</b> now.");
}

/** -------------------------
 * SUBMIT
 * ------------------------- */
function submit(){
  if (!activeCase){
    showToast("‚ö†Ô∏è No case yet. Click <b>Get Random Case</b>.");
    return;
  }

  const team = (el("teamName").value || "").trim() || "Unnamed Team";

  // Board score already computed
  let gapScore = 0;
  if (selectedGap){
    const ch = activeCase.gapChoices.find(x => x.id === selectedGap);
    gapScore = ch.best ? 30 : 10;
  } else {
    gapScore = 0;
  }

  // Twist bonus if twist is unlocked AND they added twist evidence AND used at least one T-card on board
  let twistBonus = 0;
  if (twistUnlocked && twistAdded){
    const usedTwist = ["innerThemes","innerContradictions","innerGaps"].some(id => {
      return [...el(id).children].some(node => node.id.includes("card_T"));
    });
    if (usedTwist) twistBonus = 10;
  }

  const total = score + gapScore + twistBonus;
  const code = makeCode(team, total);

  const result = el("result");
  result.style.display = "block";
  result.innerHTML = `
    <b>‚úÖ Submission Complete</b><br>
    <div class="small" style="margin-top:6px;">
      <b>Team:</b> ${escapeHTML(team)}<br>
      <b>Case:</b> ${escapeHTML(activeCase.title)}<br>
      <b>Total Score:</b> ${total} (Board ${score} + Gap ${gapScore} + Twist ${twistBonus})<br>
      <b>Shareable Code:</b> <span class="mono">${code}</span><br>
      <span class="hint">Send this code (or screenshot) to your instructor.</span>
    </div>
  `;
  result.scrollIntoView({behavior:"smooth", block:"start"});
}

/** -------------------------
 * HINT
 * ------------------------- */
function autoHint(){
  if (!activeCase){
    showToast("Hint: click <b>Get Random Case</b> first.");
    return;
  }
  const trayCount = el("tray").children.length;
  const sorted = ["innerThemes","innerContradictions","innerGaps"].reduce((acc,id)=> acc + el(id).children.length, 0);

  let msg = "";
  if (sorted < 3){
    msg = "Drag at least 3 evidence cards into the buckets. Look for patterns vs contradictions vs missing evidence.";
  } else if (!selectedGap){
    msg = "Choose a Gap statement. Strong gaps mention: conditions (type/context), missing comparisons, or weak designs/measures.";
  } else if (twistUnlocked && !twistAdded){
    msg = "Twist is unlocked: add Twist evidence and see if it changes your gap.";
  } else {
    msg = "Maximize score by placing cards into the best-matching buckets (Themes vs Contradictions vs Gap Clues).";
  }
  showToast("üí° " + msg);
}

/** -------------------------
 * RESET
 * ------------------------- */
function clearBoardAndTray(){
  ["tray","innerThemes","innerContradictions","innerGaps"].forEach(id => el(id).innerHTML = "");
  el("countThemes").textContent = "0";
  el("countContradictions").textContent = "0";
  el("countGaps").textContent = "0";
  el("result").style.display = "none";
  el("result").innerHTML = "";
}
function resetAll(){
  if (timer) clearInterval(timer);

  // Reset timers/state
  started = false;
  remaining = TOTAL_SECONDS;
  twistUnlocked = false;
  twistAdded = false;
  selectedGap = null;
  score = 0;

  // Reset case assignment
  activeCase = null;
  caseAssigned = false;

  // UI reset
  el("startBtn").disabled = false;
  el("randCaseBtn").disabled = false;
  el("changeCaseBtn").disabled = true;
  el("submitBtn").disabled = true;

  el("timerBadge").innerHTML = `‚è±Ô∏è Game: <span class="mono" id="gameTimer">20:00</span> | Twist: <span class="mono" id="twistTimer">10:00</span>`;
  // re-bind ids after reset (since we replaced innerHTML)
  // easiest: reload page, but we‚Äôll just reselect by resetting via location? no.
  // Instead: don‚Äôt replace timerBadge in production. For simplicity here: do a quick soft reload.
  location.reload();
}

/** -------------------------
 * METRICS
 * ------------------------- */
function updateMetrics(){
  const sorted = ["innerThemes","innerContradictions","innerGaps"].reduce((acc,id)=> acc + el(id).children.length, 0);
  el("sortedNum").textContent = sorted;
  el("scoreNum").textContent = score;
  el("gapPick").textContent = selectedGap ? selectedGap : "None";

  el("countThemes").textContent = el("innerThemes").children.length;
  el("countContradictions").textContent = el("innerContradictions").children.length;
  el("countGaps").textContent = el("innerGaps").children.length;
}

/** -------------------------
 * UTILS
 * ------------------------- */
function fmt(sec){
  const m = Math.floor(sec / 60);
  const s = sec % 60;
  return String(m).padStart(2,"0") + ":" + String(s).padStart(2,"0");
}
function escapeHTML(str){
  return (str || "").replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m]));
}
function makeCode(team, total){
  const base = `${team}|${activeCase ? activeCase.id : "nocase"}|${total}|${Date.now()}`;
  let hash = 0;
  for (let i=0;i<base.length;i++){ hash = (hash*31 + base.charCodeAt(i)) >>> 0; }
  return `${(activeCase ? activeCase.id : "CASE").toUpperCase()}-${total}-${String(hash).slice(0,6)}`;
}
function showToast(html){
  const t = el("result");
  t.style.display = "block";
  t.innerHTML = html;
  t.scrollIntoView({behavior:"smooth", block:"start"});
}
</script>
</body>
</html>
