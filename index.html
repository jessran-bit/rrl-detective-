<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>RRL Detective: Evidence ‚Üí Tentative Answer ‚Üí Research Gap</title>
  <style>
    :root{
      --bg:#f4f6f9; --card:#fff; --ink:#111827; --muted:#6b7280; --line:#e5e7eb;
      --accent:#111827;
      --ok:#ecfdf5; --okLine:#10b981;
      --mid:#eff6ff; --midLine:#3b82f6;
      --warn:#fffbeb; --warnLine:#f59e0b;
      --bad:#fef2f2; --badLine:#ef4444;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:Arial, sans-serif;background:var(--bg);color:var(--ink)}
    header{background:var(--accent);color:#fff;padding:14px 18px;position:sticky;top:0;z-index:10}
    header .row{display:flex;gap:12px;align-items:center;justify-content:space-between;flex-wrap:wrap}
    h1{margin:0;font-size:18px}
    .badge{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border-radius:999px;background:rgba(255,255,255,.12)}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace}

    .container{max-width:1200px;margin:0 auto;padding:16px}
    .grid{display:grid;gap:12px}
    .grid.cols{grid-template-columns:390px 1fr}
    @media (max-width:980px){.grid.cols{grid-template-columns:1fr}}

    .panel{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:14px;box-shadow:0 1px 4px rgba(0,0,0,.06)}
    h2{margin:0 0 10px;font-size:16px}
    h3{margin:0 0 8px;font-size:14px}
    p{margin:8px 0;color:var(--muted);font-size:13px;line-height:1.45}
    hr{border:none;border-top:1px solid var(--line);margin:14px 0}

    button{border:0;border-radius:10px;padding:10px 12px;cursor:pointer;font-weight:700}
    button.primary{background:var(--accent);color:#fff}
    button.secondary{background:#e5e7eb;color:var(--ink)}
    button.danger{background:#ef4444;color:#fff}
    button:disabled{opacity:.55;cursor:not-allowed}

    input[type="text"], textarea{
      padding:10px 12px;border:1px solid var(--line);border-radius:10px;width:100%;
      font-family:inherit;
    }
    textarea{min-height:120px;resize:vertical}

    .callout{
      border:1px solid var(--line);border-left:6px solid var(--accent);
      border-radius:12px;padding:10px 12px;background:#fff;
    }
    .callout b{font-size:13px}
    .callout ul{margin:8px 0 0;padding-left:18px;color:var(--muted);font-size:13px}
    .callout li{margin:4px 0}

    .miniDef{
      border:1px solid var(--line);border-radius:12px;padding:10px 12px;background:#fff;
      display:grid;gap:10px;
    }
    .miniDef .def{font-size:12px;color:var(--muted);line-height:1.45}
    .tag{
      font-size:11px;padding:3px 7px;border-radius:999px;background:#f3f4f6;color:var(--ink);
      display:inline-block;margin-right:6px;margin-top:6px
    }

    .twistBox{display:none;margin-top:10px;border:1px solid var(--warnLine);background:var(--warn);padding:10px 12px;border-radius:12px}
    .twistBox.show{display:block}

    .evidenceTray{
      min-height:120px;display:flex;flex-wrap:wrap;gap:10px;padding:10px;border:1px solid var(--line);border-radius:12px;background:#fff
    }
    .card{
      width:240px;background:#fff;border:1px solid var(--line);border-radius:12px;padding:10px;
      cursor:grab;box-shadow:0 1px 3px rgba(0,0,0,.06);user-select:none;position:relative;
    }
    .card:active{cursor:grabbing}
    .small{font-size:12px;color:var(--muted)}
    .pinBtn{
      position:absolute;top:8px;right:8px;border:1px solid var(--line);
      background:#fff;border-radius:10px;padding:6px 8px;font-size:12px;font-weight:700;cursor:pointer;
    }
    .pinned{outline:2px solid var(--okLine)}
    .pinned .pinBtn{background:var(--ok);border-color:var(--okLine)}

    .scoreBox{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin:10px 0 12px}
    .metric{background:var(--accent);color:#fff;border-radius:12px;padding:10px 12px}
    .metric span{display:block;font-size:12px;opacity:.85}
    .metric b{display:block;font-size:16px;margin-top:2px}

    .board{display:grid;grid-template-columns:repeat(4, 1fr);gap:12px}
    @media (max-width:1100px){.board{grid-template-columns:repeat(2, 1fr)}}
    @media (max-width:720px){.board{grid-template-columns:1fr}}
    .bucket{
      min-height:230px;border:2px dashed #cbd5e1;border-radius:14px;padding:10px;background:#f8fafc;
    }
    .bucket.dragover{border-color:var(--accent);background:#eef2ff}
    .bucketTitle{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
    .bucketTitle b{font-size:13px}
    .pill{font-size:12px;padding:4px 8px;border-radius:999px;background:#e5e7eb;color:var(--ink)}
    .bucketInner{display:flex;flex-wrap:wrap;gap:10px}
    .hint{font-size:12px;color:var(--muted)}

    .choices{display:grid;gap:8px;margin-top:10px}
    .choice{padding:10px 12px;border-radius:12px;border:1px solid var(--line);background:#fff;cursor:pointer}
    .choice.selected{outline:2px solid var(--accent)}
    .choice small{color:var(--muted)}

    .toast{
      margin-top:10px;padding:10px 12px;border-radius:12px;border:1px solid var(--line);background:#fff;display:none
    }

    .tinyNote{font-size:11px;color:var(--muted);margin-top:8px}

    .instructor{
      display:none;border:1px solid var(--line);border-left:6px solid var(--accent);
      border-radius:12px;padding:12px;background:#fff;margin-top:12px;
    }
    .instructor.show{display:block}

    .statusPill{display:inline-block;font-size:12px;padding:3px 10px;border-radius:999px;border:1px solid var(--line)}
    .status-green{background:var(--ok);border-color:var(--okLine)}
    .status-blue{background:var(--mid);border-color:var(--midLine)}
    .status-yellow{background:var(--warn);border-color:var(--warnLine)}
    .status-red{background:var(--bad);border-color:var(--badLine)}

    table{border-collapse:collapse;width:100%;font-size:12px}
    th,td{border:1px solid var(--line);padding:8px;vertical-align:top}
    th{background:#f3f4f6;text-align:left}

    .analyticsGrid{display:grid;gap:10px;grid-template-columns:repeat(3, 1fr)}
    @media (max-width:980px){.analyticsGrid{grid-template-columns:1fr}}
    .analyticsCard{border:1px solid var(--line);border-radius:12px;padding:10px;background:#fff}
    .analyticsCard b{display:block;margin-bottom:6px}
    .muted{color:var(--muted)}
  </style>
</head>

<body>
<header>
  <div class="row">
    <h1>üîé RRL Detective: Evidence ‚Üí Tentative Answer ‚Üí Research Gap</h1>
    <div class="badge" id="timerBadge">
      ‚è±Ô∏è <b>Game:</b> <span class="mono" id="gameTimer">20:00</span>
      &nbsp;|&nbsp; <b>Twist in:</b> <span class="mono" id="twistTimer">05:00</span>
    </div>
  </div>
</header>

<div class="container">
  <div class="grid cols">

    <!-- LEFT -->
    <div class="panel">
      <h2>1) Load a Case (Timer starts automatically)</h2>
      <p>Click once. The 20-minute timer starts as soon as the case loads. The twist unlocks <b>5 minutes after the case starts</b>.</p>

      <div style="display:grid; gap:10px;">
        <input id="teamName" type="text" placeholder="Team name (required)" />
        <div style="display:flex; gap:10px; flex-wrap:wrap;">
          <button class="primary" id="randCaseBtn" onclick="assignRandomCase()">üé≤ Load Random Case (6 cases)</button>
          <button class="secondary" onclick="resetAll()">Reset</button>
          <button class="secondary" onclick="toggleInstructor()">Instructor Dashboard</button>
        </div>
      </div>
      <div class="tinyNote">Each case has <b>15 evidence cards</b> (twist adds 2).</div>

      <!-- Instructor dashboard -->
      <div class="instructor" id="instructorPanel">
        <h3>Instructor Dashboard</h3>
        <p>Paste student submissions here (codes can be wrapped). Click <b>Parse</b> to build a table and analytics summary.</p>
        <textarea id="codesInput" placeholder="Paste everything here (chat exports are OK)."></textarea>
        <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:10px;">
          <button class="primary" onclick="parseCodes()">Parse</button>
          <button class="secondary" onclick="downloadCSV()">Download CSV</button>
          <button class="danger" onclick="clearInstructor()">Clear</button>
        </div>

        <div id="parseSummary" class="tinyNote" style="margin-top:8px;"></div>

        <div class="analyticsGrid" style="margin-top:10px;" id="analyticsGrid"></div>

        <div style="margin-top:10px; overflow:auto;">
          <table id="resultsTable"></table>
        </div>

        <div class="tinyNote" style="margin-top:8px;">
          Tip: ask students to submit: <span class="mono">TEAM | Submission Code</span>
        </div>
      </div>

      <div class="callout" style="margin-top:12px;">
        <b id="caseTitle">No case yet</b>
        <div class="small" id="caseSubtitle" style="margin-top:6px;">Load a case to begin.</div>
      </div>

      <div class="callout" style="margin-top:10px;">
        <b>Research Problem</b>
        <div class="small" id="problemText" style="margin-top:6px;">‚Äî</div>
      </div>

      <div class="callout" style="margin-top:10px;">
        <b>What your RRL must produce</b>
        <ul>
          <li>A <b>tentative answer</b> based on evidence patterns</li>
          <li>Gap type(s): <b>theoretical</b>, <b>contextual</b>, <b>methodological</b></li>
          <li>At least <b>2 pinned evidence</b> cards to justify your reasoning</li>
        </ul>
      </div>

      <div class="miniDef" style="margin-top:10px;">
        <b>Types of Research Gaps</b>

        <div class="def">
          <span class="tag">Theoretical gap</span>
          Studies show patterns or relationships, but the explanation is unclear.
          The literature may answer ‚Äúwhat is happening‚Äù but not ‚Äúwhy or how it happens.‚Äù
          Look for missing mechanisms, missing concepts, or untested explanations.
        </div>

        <div class="def">
          <span class="tag">Contextual gap</span>
          Findings may not apply across populations, settings, or time periods.
          Look for ‚Äúit depends‚Äù evidence, missing comparisons (e.g., rural vs urban), or outdated data that may not fit today‚Äôs context.
        </div>

        <div class="def">
          <span class="tag">Methodological gap</span>
          Designs or measurements limit confidence in conclusions.
          Look for cross-sectional surveys, weak measures, missing process data, missing comparison groups, or calls for stronger methods.
        </div>
      </div>

      <div class="twistBox" id="twistBox">
        <b>üö® Twist unlocked</b>
        <p class="small" id="twistText"></p>
        <button class="secondary" onclick="addTwistCards()">Add Twist Evidence</button>
      </div>

      <hr>

      <h2>2) Evidence Tray</h2>
      <p>Drag evidence into buckets. Cards can fit multiple interpretations. That‚Äôs normal in RRL.</p>
      <div class="evidenceTray" id="tray" ondragover="allowDrop(event)" ondrop="dropToTray(event)"></div>
      <p class="hint">Tip: Click <b>Pin</b> on a card to use it as evidence for your final answers.</p>
    </div>

    <!-- RIGHT -->
    <div class="panel">
      <h2>Evidence Sorting Board</h2>

      <div class="scoreBox">
        <div class="metric"><span>Score</span><b id="scoreNum">0</b></div>
        <div class="metric"><span>Cards Sorted</span><b id="sortedNum">0</b></div>
        <div class="metric"><span>Pinned Evidence</span><b id="pinnedNum">0</b></div>
      </div>

      <div class="board">
        <div class="bucket" ondragover="bucketOver(event)" ondragleave="bucketLeave(event)" ondrop="dropToBucket(event, 'claimA')">
          <div class="bucketTitle"><b>üìå Supports Claim A</b><span class="pill" id="countA">0</span></div>
          <div class="bucketInner" id="innerA"></div>
          <p class="hint" id="claimAText">Load a case to see Claim A.</p>
        </div>

        <div class="bucket" ondragover="bucketOver(event)" ondragleave="bucketLeave(event)" ondrop="dropToBucket(event, 'claimB')">
          <div class="bucketTitle"><b>üìå Supports Claim B</b><span class="pill" id="countB">0</span></div>
          <div class="bucketInner" id="innerB"></div>
          <p class="hint" id="claimBText">Load a case to see Claim B.</p>
        </div>

        <div class="bucket" ondragover="bucketOver(event)" ondragleave="bucketLeave(event)" ondrop="dropToBucket(event, 'boundary')">
          <div class="bucketTitle"><b>üß≠ Boundary / Context</b><span class="pill" id="countC">0</span></div>
          <div class="bucketInner" id="innerC"></div>
          <p class="hint">Evidence that explains ‚Äúit depends‚Äù (population, setting, time, conditions).</p>
        </div>

        <div class="bucket" ondragover="bucketOver(event)" ondragleave="bucketLeave(event)" ondrop="dropToBucket(event, 'methods')">
          <div class="bucketTitle"><b>üß™ Method / Measurement Limits</b><span class="pill" id="countM">0</span></div>
          <div class="bucketInner" id="innerM"></div>
          <p class="hint">Evidence showing design weaknesses (weak measures, missing comparisons, process gaps).</p>
        </div>
      </div>

      <hr>

      <h2>Final Outputs</h2>
      <p>Choose a tentative answer + gap type(s), then pin evidence to justify.</p>

      <h3>Tentative Answer</h3>
      <div class="choices" id="answerChoices"></div>

      <h3 style="margin-top:12px;">Gap Type(s)</h3>
      <div class="choices" id="gapChoices"></div>

      <div class="callout" id="preSubmitCheck" style="margin-top:12px; display:none;">
        <b>Pre-Submit Sense Check</b>
        <div class="small" id="preSubmitBody" style="margin-top:6px;"></div>
      </div>

      <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:12px;">
        <button class="primary" onclick="submit()" id="submitBtn" disabled>Submit</button>
        <button class="secondary" onclick="hint()">Hint</button>
      </div>

      <div id="result" class="toast"></div>
    </div>

  </div>
</div>

<script>
/** ========= Timing ========= */
const TOTAL_SECONDS = 20 * 60;
// twist unlocks AFTER 5 minutes elapsed
const TWIST_UNLOCK_AFTER_ELAPSED = 5 * 60;

let remaining = TOTAL_SECONDS;
let timer = null;
let started = false;
let startEpochMs = null;

/** ========= State ========= */
let activeCase = null;
let twistUnlocked = false;
let twistAdded = false;
let answerPick = null;
let gapTypePicks = new Set();
let pinned = new Set();
let score = 0;

/** ========= Cases (balanced) =========
 * Per case (15 cards): 5 claimA, 5 claimB, 3 boundary, 2 methods
 * Twist (2): 1 boundary, 1 methods
 */
const CASES = [
  {
    id: "socialmedia",
    title: "Case 1: Social Media Use & Academic Performance",
    subtitle: "Advise a college: does social media harm academic performance?",
    problem: "Based on current studies, what is the most reasonable tentative answer about social media use and academic performance? What gap should a new study address?",
    claimA: "Claim A: More social media use is linked to lower academic performance.",
    claimB: "Claim B: Effects are conditional; outcomes depend on how social media is used and context.",
    answerKey: "MIXED_DEPENDS",
    gapKey: ["CONTEXTUAL","METHODOLOGICAL"],
    cards: [
      // Claim A (5)
      { id:"SM1",  title:"Study (College Survey)", text:"Higher daily use correlates with lower GPA.", roles:["claimA"], gapHints:["METHODOLOGICAL"], meta:["Cross-sectional correlation"] },
      { id:"SM2",  title:"Study (Notifications)", text:"Frequent notifications reduce time-on-task during study sessions.", roles:["claimA"], gapHints:["THEORETICAL"], meta:["Attention disruption clue"] },
      { id:"SM3",  title:"Study (Late-night Use)", text:"Late-night social media use predicts shorter sleep and lower quiz scores.", roles:["claimA"], gapHints:["THEORETICAL"], meta:["Sleep pathway clue"] },
      { id:"SM4",  title:"Study (Multitasking)", text:"Students who multitask with social media during lectures score lower on recall tests.", roles:["claimA"], gapHints:["THEORETICAL"], meta:["Multitasking cost"] },
      { id:"SM5",  title:"Study (Small Intervention)", text:"A notification-reduction intervention improves focus and assignment completion.", roles:["claimA"], gapHints:["METHODOLOGICAL"], meta:["Small trial; short follow-up"] },

      // Claim B (5)
      { id:"SM6",  title:"Study (No Link)", text:"In one sample, overall screen time shows no significant association with GPA.", roles:["claimB"], gapHints:["CONTEXTUAL"], meta:["Null result"] },
      { id:"SM7",  title:"Study (Academic Use)", text:"Using social media for academic groups is associated with higher course engagement.", roles:["claimB"], gapHints:["THEORETICAL"], meta:["Resource/engagement pathway"] },
      { id:"SM8",  title:"Study (Active Networking)", text:"Active academic networking is neutral or positive for performance compared with passive scrolling.", roles:["claimB"], gapHints:["THEORETICAL"], meta:["Use-type matters"] },
      { id:"SM9",  title:"Study (High Self-control)", text:"High self-control students show little to no negative effect from social media use.", roles:["claimB"], gapHints:["THEORETICAL","CONTEXTUAL"], meta:["Moderator"] },
      { id:"SM10", title:"Study (Platform Variation)", text:"Effects differ across platforms; some platform use is unrelated to grades.", roles:["claimB"], gapHints:["CONTEXTUAL"], meta:["Platform differences"] },

      // Boundary/Context (3)
      { id:"SM11", title:"Boundary (Passive vs Active)", text:"Studies define 'use' differently (passive scrolling vs active posting), which can change conclusions.", roles:["boundary"], gapHints:["CONTEXTUAL"], meta:["Definition boundary"] },
      { id:"SM12", title:"Boundary (Time Period)", text:"Platform features changed after remote learning; older results may not reflect today‚Äôs usage.", roles:["boundary"], gapHints:["CONTEXTUAL"], meta:["Time/context shift"] },
      { id:"SM13", title:"Boundary (Population)", text:"Many studies use high school samples; transfer to college contexts is uncertain.", roles:["boundary"], gapHints:["CONTEXTUAL"], meta:["Population mismatch"] },

      // Methods (2)
      { id:"SM14", title:"Method (Self-report)", text:"Most studies rely on self-reported screen time; measurement reliability is a concern.", roles:["methods"], gapHints:["METHODOLOGICAL"], meta:["Validity concern"] },
      { id:"SM15", title:"Method (Causality)", text:"Many designs are one-time surveys, so causal direction remains unclear.", roles:["methods"], gapHints:["METHODOLOGICAL"], meta:["Need stronger designs"] },
    ],
    twist: {
      text: "New evidence arrives: stronger designs and refined definitions change how we interpret the pattern.",
      cards: [
        { id:"TSM1", title:"Twist (Boundary: Engagement Type)", text:"A synthesis shows effects vary strongly by engagement type (passive vs active).", roles:["boundary"], gapHints:["CONTEXTUAL"], meta:["Explains mixed findings"] },
        { id:"TSM2", title:"Twist (Method: Longitudinal)", text:"Longitudinal studies show different patterns than cross-sectional surveys.", roles:["methods"], gapHints:["METHODOLOGICAL"], meta:["Design quality matters"] },
      ]
    }
  },

  {
    id: "digitalbank",
    title: "Case 2: Digital Loan Apps & Financial Inclusion",
    subtitle: "Evaluate whether digital loan applications exclude low-income households.",
    problem: "Are digital loan application processes financially inclusive for low-income households, or do they create barriers? What tentative answer fits the evidence pattern, and what gap remains?",
    claimA: "Claim A: Digital loan apps increase access for previously unbanked applicants.",
    claimB: "Claim B: Digital loan apps can exclude low-income users through process barriers (KYC, literacy, connectivity).",
    answerKey: "BOTH_TRUE_PROCESS_GAP",
    gapKey: ["METHODOLOGICAL","CONTEXTUAL"],
    cards: [
      // Claim A (5)
      { id:"DB1",  title:"Study (Access Expansion)", text:"Digital lending expands access among previously unbanked applicants.", roles:["claimA"], gapHints:["CONTEXTUAL"], meta:["Who benefits: unbanked"] },
      { id:"DB2",  title:"Study (Faster Decisions)", text:"App-based processing reduces waiting time and increases completed applications.", roles:["claimA"], gapHints:["THEORETICAL"], meta:["Convenience pathway"] },
      { id:"DB3",  title:"Study (Lower Transaction Costs)", text:"Applicants report lower transport and paperwork costs compared with in-branch applications.", roles:["claimA"], gapHints:["CONTEXTUAL"], meta:["Cost barrier reduced"] },
      { id:"DB4",  title:"Study (Assisted Onboarding)", text:"Agent-assisted onboarding improves completion rates for first-time users.", roles:["claimA"], gapHints:["CONTEXTUAL"], meta:["Support matters"] },
      { id:"DB5",  title:"Study (Micro-loans Uptake)", text:"Micro-loan uptake increases in communities with limited bank branches.", roles:["claimA"], gapHints:["CONTEXTUAL"], meta:["Branch scarcity context"] },

      // Claim B (5)
      { id:"DB6",  title:"Study (KYC Drop-off)", text:"Large drop-off occurs during ID/document upload steps.", roles:["claimB"], gapHints:["METHODOLOGICAL"], meta:["Process bottleneck"] },
      { id:"DB7",  title:"Study (Digital Literacy)", text:"Lower digital literacy predicts incomplete applications.", roles:["claimB"], gapHints:["CONTEXTUAL"], meta:["Skill barrier"] },
      { id:"DB8",  title:"Study (Connectivity)", text:"Low connectivity users are less likely to finish onboarding.", roles:["claimB"], gapHints:["CONTEXTUAL"], meta:["Infrastructure barrier"] },
      { id:"DB9",  title:"Study (Hidden Costs/Terms)", text:"Some users abandon applications due to unclear terms and perceived hidden fees.", roles:["claimB"], gapHints:["THEORETICAL","CONTEXTUAL"], meta:["Trust/comprehension"] },
      { id:"DB10", title:"Study (Algorithmic Underscoring)", text:"Automated scoring may underpredict for informal workers, increasing rejection risk.", roles:["claimB"], gapHints:["METHODOLOGICAL","CONTEXTUAL"], meta:["Data bias risk"] },

      // Boundary (3)
      { id:"DB11", title:"Boundary (Rural vs Urban)", text:"Evidence is limited on rural-versus-urban differences in completion and approval.", roles:["boundary"], gapHints:["CONTEXTUAL"], meta:["Missing comparison"] },
      { id:"DB12", title:"Boundary (Policy Constraints)", text:"Strict ID/KYC requirements can exclude users without documentation.", roles:["boundary"], gapHints:["CONTEXTUAL"], meta:["Policy boundary"] },
      { id:"DB13", title:"Boundary (Support Availability)", text:"Outcomes differ where community support or agents are available versus self-service only.", roles:["boundary"], gapHints:["CONTEXTUAL"], meta:["Support boundary"] },

      // Methods (2)
      { id:"DB14", title:"Method (Outcome-only)", text:"Many studies report approval outcomes but not where applicants drop off and why.", roles:["methods"], gapHints:["METHODOLOGICAL"], meta:["Missing process-level evidence"] },
      { id:"DB15", title:"Method (Journey Mapping Rare)", text:"Few studies map the user journey end-to-end with step-by-step data.", roles:["methods"], gapHints:["METHODOLOGICAL"], meta:["Need funnel/journey data"] },
    ],
    twist: {
      text: "A policy change and a UX intervention arrive mid-game. Re-check your synthesis.",
      cards: [
        { id:"TDB1", title:"Twist (Boundary: Policy Tightening)", text:"Stricter KYC rules increase abandonment among low-income applicants.", roles:["boundary"], gapHints:["CONTEXTUAL"], meta:["Policy-context interaction"] },
        { id:"TDB2", title:"Twist (Method: In-app Guidance Study)", text:"A field experiment shows guided help reduces abandonment for low-literacy users.", roles:["methods"], gapHints:["METHODOLOGICAL"], meta:["Stronger design evidence"] },
      ]
    }
  },

  {
    id: "remotework",
    title: "Case 3: Remote Work & Productivity",
    subtitle: "Does remote work increase or decrease productivity?",
    problem: "A manager asks whether remote work improves productivity. Based on studies, what tentative answer fits best, and what gap remains?",
    claimA: "Claim A: Remote work increases productivity.",
    claimB: "Claim B: Remote work does not consistently increase productivity; effects depend on role, support, and home context.",
    answerKey: "MIXED_DEPENDS",
    gapKey: ["CONTEXTUAL","METHODOLOGICAL"],
    cards: [
      // Claim A (5)
      { id:"RW1",  title:"Study (Output Increase)", text:"Some teams show higher output after going remote.", roles:["claimA"], gapHints:["METHODOLOGICAL"], meta:["Output metric used"] },
      { id:"RW2",  title:"Study (Fewer Commute Hours)", text:"Reduced commuting time is associated with more time for work tasks.", roles:["claimA"], gapHints:["THEORETICAL"], meta:["Time reallocation"] },
      { id:"RW3",  title:"Study (Focus Gains)", text:"Employees report fewer interruptions and better focus at home.", roles:["claimA"], gapHints:["THEORETICAL"], meta:["Focus pathway"] },
      { id:"RW4",  title:"Study (Turnover Intention)", text:"Remote options reduce turnover intention in some groups.", roles:["claimA"], gapHints:["CONTEXTUAL"], meta:["Outcome differs by metric"] },
      { id:"RW5",  title:"Study (Norms Help)", text:"Clear team norms (core hours, response rules) improve remote performance.", roles:["claimA"], gapHints:["THEORETICAL"], meta:["Mechanism: norms"] },

      // Claim B (5)
      { id:"RW6",  title:"Study (Coordination Loss)", text:"Collaboration quality declines without coordination routines.", roles:["claimB"], gapHints:["THEORETICAL","CONTEXTUAL"], meta:["Coordination cost"] },
      { id:"RW7",  title:"Study (Interdependence)", text:"Highly interdependent tasks face more delays and rework when remote.", roles:["claimB"], gapHints:["CONTEXTUAL"], meta:["Task structure"] },
      { id:"RW8",  title:"Study (Home Constraints)", text:"Crowded or noisy homes are linked to lower productivity.", roles:["claimB"], gapHints:["CONTEXTUAL"], meta:["Home environment"] },
      { id:"RW9",  title:"Study (Care Load)", text:"Care responsibilities reduce productivity for some workers.", roles:["claimB"], gapHints:["CONTEXTUAL"], meta:["Household context"] },
      { id:"RW10", title:"Study (Monitoring Backfires)", text:"Heavy monitoring reduces autonomy and is linked to lower performance.", roles:["claimB"], gapHints:["THEORETICAL"], meta:["Control mechanism"] },

      // Boundary (3)
      { id:"RW11", title:"Boundary (Role Differences)", text:"Results differ by role type (knowledge work vs frontline/coordination-heavy roles).", roles:["boundary"], gapHints:["CONTEXTUAL"], meta:["Role boundary"] },
      { id:"RW12", title:"Boundary (Pandemic Context)", text:"Lockdown findings may not represent normal remote work arrangements.", roles:["boundary"], gapHints:["CONTEXTUAL"], meta:["Exceptional conditions"] },
      { id:"RW13", title:"Boundary (Support Resources)", text:"Outcomes depend on tools, IT support, and managerial practices.", roles:["boundary"], gapHints:["CONTEXTUAL"], meta:["Resource boundary"] },

      // Methods (2)
      { id:"RW14", title:"Method (Self-report)", text:"Many studies rely on self-reported productivity rather than objective metrics.", roles:["methods"], gapHints:["METHODOLOGICAL"], meta:["Measurement bias"] },
      { id:"RW15", title:"Method (Comparisons Missing)", text:"Few studies compare remote vs hybrid vs onsite within the same firm.", roles:["methods"], gapHints:["METHODOLOGICAL"], meta:["Need cleaner comparisons"] },
    ],
    twist: {
      text: "New evidence focuses on time dynamics and design quality.",
      cards: [
        { id:"TRW1", title:"Twist (Boundary: Time Effects)", text:"Productivity gains appear early but fade without ongoing coordination support.", roles:["boundary"], gapHints:["CONTEXTUAL"], meta:["Time boundary"] },
        { id:"TRW2", title:"Twist (Method: Quasi-experiment)", text:"A quasi-experimental study shows smaller effects than surveys suggest.", roles:["methods"], gapHints:["METHODOLOGICAL"], meta:["Design quality"] },
      ]
    }
  },

  {
    id: "ai_learning",
    title: "Case 4: AI Tools & Student Learning",
    subtitle: "Do AI tools improve learning, or reduce deep thinking?",
    problem: "A school wants guidance on allowing AI tools. Based on studies, what tentative answer fits, and what gap remains?",
    claimA: "Claim A: AI tools improve learning outcomes.",
    claimB: "Claim B: AI tools may reduce deep learning unless guided; effects depend on use patterns.",
    answerKey: "MIXED_DEPENDS",
    gapKey: ["THEORETICAL","METHODOLOGICAL"],
    cards: [
      // Claim A (5)
      { id:"AI1",  title:"Study (Practice Support)", text:"AI tutoring increases practice frequency and short-term scores.", roles:["claimA"], gapHints:["METHODOLOGICAL"], meta:["Short-term outcomes"] },
      { id:"AI2",  title:"Study (Feedback Speed)", text:"Students receive faster feedback and complete more revisions with AI support.", roles:["claimA"], gapHints:["THEORETICAL"], meta:["Feedback loop"] },
      { id:"AI3",  title:"Study (Writing Quality)", text:"AI-assisted drafting improves clarity and structure in student writing.", roles:["claimA"], gapHints:["METHODOLOGICAL"], meta:["Rubric-based scoring"] },
      { id:"AI4",  title:"Study (Scaffolded Use)", text:"Structured AI activities (prompt + reflect) improve quiz performance.", roles:["claimA"], gapHints:["THEORETICAL"], meta:["Scaffolding effect"] },
      { id:"AI5",  title:"Study (Study Planning)", text:"AI study planners increase on-time submission and planning behaviors.", roles:["claimA"], gapHints:["THEORETICAL"], meta:["Self-regulation support"] },

      // Claim B (5)
      { id:"AI6",  title:"Study (Copying Risk)", text:"Some students copy AI answers; grades rise but understanding is unclear.", roles:["claimB"], gapHints:["THEORETICAL","METHODOLOGICAL"], meta:["Mechanism unclear"] },
      { id:"AI7",  title:"Study (Reduced Struggle)", text:"AI reduces cognitive load and may reduce productive struggle needed for mastery.", roles:["claimB"], gapHints:["THEORETICAL"], meta:["Learning mechanism"] },
      { id:"AI8",  title:"Study (Unguided Use)", text:"Unrestricted AI use increases shortcut behaviors and shallow revisions.", roles:["claimB"], gapHints:["THEORETICAL"], meta:["Use pattern"] },
      { id:"AI9",  title:"Study (Equity)", text:"Students with weaker access/devices benefit less from AI tools.", roles:["claimB"], gapHints:["CONTEXTUAL"], meta:["Access inequality"] },
      { id:"AI10", title:"Study (Policy Anxiety)", text:"Strict integrity policies increase anxiety and reduce help-seeking.", roles:["claimB"], gapHints:["CONTEXTUAL"], meta:["Policy context"] },

      // Boundary (3)
      { id:"AI11", title:"Boundary (Discipline)", text:"Effects differ by task type (writing, math, coding) and assessment format.", roles:["boundary"], gapHints:["CONTEXTUAL"], meta:["Domain boundary"] },
      { id:"AI12", title:"Boundary (Prompt Skill)", text:"Outcomes depend on students‚Äô prompting skill and metacognitive habits.", roles:["boundary"], gapHints:["CONTEXTUAL"], meta:["Skill boundary"] },
      { id:"AI13", title:"Boundary (Teacher Scaffolding)", text:"Guided classroom use performs differently than independent, out-of-class use.", roles:["boundary"], gapHints:["CONTEXTUAL"], meta:["Setting boundary"] },

      // Methods (2)
      { id:"AI14", title:"Method (Process Missing)", text:"Many studies measure grades but not how students actually used AI while working.", roles:["methods"], gapHints:["METHODOLOGICAL"], meta:["Process data missing"] },
      { id:"AI15", title:"Method (Retention Rare)", text:"Long-term retention outcomes are rarely reported.", roles:["methods"], gapHints:["METHODOLOGICAL"], meta:["Need longer follow-up"] },
    ],
    twist: {
      text: "New evidence: logs and stronger methods change conclusions.",
      cards: [
        { id:"TAI1", title:"Twist (Boundary: Guided vs Unguided)", text:"Guided use shows better retention than unguided use.", roles:["boundary"], gapHints:["CONTEXTUAL"], meta:["Condition boundary"] },
        { id:"TAI2", title:"Twist (Method: Log Data)", text:"Log-data reveals different learning paths than surveys report.", roles:["methods"], gapHints:["METHODOLOGICAL"], meta:["Better measurement"] },
      ]
    }
  },

  {
    id: "hybrid_wellbeing",
    title: "Case 5: Hybrid Work & Employee Well-being",
    subtitle: "Does hybrid work improve well-being, or increase role strain?",
    problem: "An organization wants a hybrid policy. Based on studies, what tentative answer fits, and what gap remains?",
    claimA: "Claim A: Hybrid work improves well-being through flexibility and autonomy.",
    claimB: "Claim B: Hybrid work can increase role strain; outcomes depend on job resources and home demands.",
    answerKey: "MIXED_DEPENDS",
    gapKey: ["THEORETICAL","CONTEXTUAL"],
    cards: [
      // Claim A (5)
      { id:"HW1",  title:"Study (Flexibility)", text:"Flexibility predicts higher well-being in multiple samples.", roles:["claimA"], gapHints:["THEORETICAL"], meta:["Resource clue"] },
      { id:"HW2",  title:"Study (Autonomy)", text:"Autonomy predicts engagement and satisfaction in hybrid schedules.", roles:["claimA"], gapHints:["THEORETICAL"], meta:["Mechanism clue"] },
      { id:"HW3",  title:"Study (Commute Relief)", text:"Reduced commuting time is linked to better daily mood and less fatigue.", roles:["claimA"], gapHints:["THEORETICAL"], meta:["Resource pathway"] },
      { id:"HW4",  title:"Study (Boundary Strategies)", text:"Boundary management strategies reduce conflict and improve well-being.", roles:["claimA"], gapHints:["THEORETICAL"], meta:["Mechanism clue"] },
      { id:"HW5",  title:"Study (Schedule Fit)", text:"Employees with choice over hybrid days report higher satisfaction.", roles:["claimA"], gapHints:["CONTEXTUAL"], meta:["Choice matters"] },

      // Claim B (5)
      { id:"HW6",  title:"Study (Boundary Blurring)", text:"Work-home boundary blurring predicts stress and burnout.", roles:["claimB"], gapHints:["THEORETICAL"], meta:["Mechanism clue"] },
      { id:"HW7",  title:"Study (Isolation)", text:"Isolation increases for remote-heavy schedules, lowering well-being for some.", roles:["claimB"], gapHints:["CONTEXTUAL"], meta:["Schedule effect"] },
      { id:"HW8",  title:"Study (Workload Cancels Benefits)", text:"High workload cancels flexibility benefits and raises strain.", roles:["claimB"], gapHints:["THEORETICAL"], meta:["Interaction"] },
      { id:"HW9",  title:"Study (Care Demands)", text:"Care responsibilities are linked to higher strain under hybrid work.", roles:["claimB"], gapHints:["CONTEXTUAL"], meta:["Home demand"] },
      { id:"HW10", title:"Study (Resource Quality)", text:"Poor-quality support (unclear expectations, weak tools) increases conflict.", roles:["claimB"], gapHints:["THEORETICAL"], meta:["Quality mechanism"] },

      // Boundary (3)
      { id:"HW11", title:"Boundary (Household Structure)", text:"Outcomes differ by household structure and unpaid work distribution.", roles:["boundary"], gapHints:["CONTEXTUAL"], meta:["Population boundary"] },
      { id:"HW12", title:"Boundary (Policy Variation)", text:"Different organizational hybrid policies make results hard to compare.", roles:["boundary"], gapHints:["CONTEXTUAL"], meta:["Policy boundary"] },
      { id:"HW13", title:"Boundary (Role Type)", text:"Well-being impacts differ by role (client-facing vs independent work).", roles:["boundary"], gapHints:["CONTEXTUAL"], meta:["Job boundary"] },

      // Methods (2)
      { id:"HW14", title:"Method (Cross-sectional)", text:"Most studies are cross-sectional; mechanisms over time are uncertain.", roles:["methods"], gapHints:["METHODOLOGICAL"], meta:["Time dynamics unclear"] },
      { id:"HW15", title:"Method (Measures Vary)", text:"Well-being measures differ across studies; comparability is limited.", roles:["methods"], gapHints:["METHODOLOGICAL"], meta:["Measurement variability"] },
    ],
    twist: {
      text: "New evidence emphasizes boundary conditions and stronger designs.",
      cards: [
        { id:"THW1", title:"Twist (Boundary: Balance Condition)", text:"Thriving occurs when resources offset home demands; otherwise strain grows.", roles:["boundary"], gapHints:["CONTEXTUAL"], meta:["Balance condition"] },
        { id:"THW2", title:"Twist (Method: Longitudinal)", text:"A longitudinal study shows well-being shifts across the first 6 months.", roles:["methods"], gapHints:["METHODOLOGICAL"], meta:["Time-based evidence"] },
      ]
    }
  },

  {
    id: "sme_sustainability",
    title: "Case 6: Sustainability Practices in SMEs",
    subtitle: "Do sustainability practices improve SME performance?",
    problem: "An SME association asks: do sustainability practices improve performance, and what is still missing in the evidence?",
    claimA: "Claim A: Sustainability practices improve SME performance and competitiveness.",
    claimB: "Claim B: Sustainability does not consistently improve performance; outcomes depend on implementation, context, and measurement quality.",
    answerKey: "MIXED_DEPENDS",
    gapKey: ["METHODOLOGICAL","CONTEXTUAL"],
    cards: [
      // Claim A (5)
      { id:"SS1",  title:"Study (Market Preference)", text:"Green branding predicts preference in some customer segments.", roles:["claimA"], gapHints:["CONTEXTUAL"], meta:["Market benefit"] },
      { id:"SS2",  title:"Study (Efficiency Gains)", text:"Energy-saving practices reduce operating costs for some SMEs.", roles:["claimA"], gapHints:["THEORETICAL"], meta:["Cost efficiency"] },
      { id:"SS3",  title:"Study (Buyer Requirements)", text:"Meeting sustainability requirements helps SMEs access supply chains.", roles:["claimA"], gapHints:["CONTEXTUAL"], meta:["Market access"] },
      { id:"SS4",  title:"Study (Employee Pride)", text:"Sustainability initiatives are linked to higher employee commitment in SMEs.", roles:["claimA"], gapHints:["THEORETICAL"], meta:["Human resource pathway"] },
      { id:"SS5",  title:"Study (Financing Support)", text:"SMEs with sustainability-linked financing show better growth outcomes.", roles:["claimA"], gapHints:["CONTEXTUAL"], meta:["Resource support"] },

      // Claim B (5)
      { id:"SS6",  title:"Study (Upfront Cost Barrier)", text:"Upfront costs reduce adoption among constrained SMEs.", roles:["claimB"], gapHints:["CONTEXTUAL"], meta:["Resource constraint"] },
      { id:"SS7",  title:"Study (Short-term Dip)", text:"Short-term profits may dip after adopting practices; long-term gains unclear.", roles:["claimB"], gapHints:["METHODOLOGICAL"], meta:["Time horizon issue"] },
      { id:"SS8",  title:"Study (Implementation Burden)", text:"Limited staff/time makes implementation uneven, reducing benefits.", roles:["claimB"], gapHints:["CONTEXTUAL"], meta:["Capability constraint"] },
      { id:"SS9",  title:"Study (Market WTP Low)", text:"Benefits are weak in markets with low willingness-to-pay for sustainability.", roles:["claimB"], gapHints:["CONTEXTUAL"], meta:["Market boundary"] },
      { id:"SS10", title:"Study (Reverse Causality)", text:"High-performing SMEs may adopt sustainability because they can.", roles:["claimB"], gapHints:["METHODOLOGICAL"], meta:["Causal ambiguity"] },

      // Boundary (3)
      { id:"SS11", title:"Boundary (Industry)", text:"Effects differ by industry (food, retail, manufacturing).", roles:["boundary"], gapHints:["CONTEXTUAL"], meta:["Industry boundary"] },
      { id:"SS12", title:"Boundary (Regulatory Context)", text:"Regulation strength changes the value of sustainability investments.", roles:["boundary"], gapHints:["CONTEXTUAL"], meta:["Policy boundary"] },
      { id:"SS13", title:"Boundary (Local Conditions)", text:"Across countries and regions, results vary widely due to local conditions.", roles:["boundary"], gapHints:["CONTEXTUAL"], meta:["Context variability"] },

      // Methods (2)
      { id:"SS14", title:"Method (Self-report Bias)", text:"Practices are often self-reported; greenwashing risk affects findings.", roles:["methods"], gapHints:["METHODOLOGICAL"], meta:["Validity concern"] },
      { id:"SS15", title:"Method (Metrics Inconsistent)", text:"Performance is measured differently across studies, limiting comparisons.", roles:["methods"], gapHints:["METHODOLOGICAL"], meta:["Inconsistent metrics"] },
    ],
    twist: {
      text: "New evidence focuses on verification and measurement quality.",
      cards: [
        { id:"TSS1", title:"Twist (Boundary: Eco-label Recognition)", text:"Benefits are strongest where eco-label recognition is high.", roles:["boundary"], gapHints:["CONTEXTUAL"], meta:["Market condition"] },
        { id:"TSS2", title:"Twist (Method: Audits)", text:"Audited practices predict performance better than self-reports.", roles:["methods"], gapHints:["METHODOLOGICAL"], meta:["Measurement quality"] },
      ]
    }
  }
];

/** ========= UI helpers ========= */
const el = (id)=>document.getElementById(id);
const fmt = (sec)=>`${String(Math.floor(sec/60)).padStart(2,"0")}:${String(sec%60).padStart(2,"0")}`;
function escapeHTML(str){ return (str||"").replace(/[&<>"']/g,m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;" }[m])); }

/** ========= Base64URL helpers ========= */
function b64urlEncode(str){
  const b64 = btoa(unescape(encodeURIComponent(str)));
  return b64.replace(/\+/g,'-').replace(/\//g,'_').replace(/=+$/,'');
}
function b64urlDecode(str){
  const b64 = str.replace(/-/g,'+').replace(/_/g,'/');
  const pad = b64.length % 4 ? '='.repeat(4 - (b64.length % 4)) : '';
  return decodeURIComponent(escape(atob(b64 + pad)));
}
function fnv1a32(str){
  let h = 0x811c9dc5;
  for (let i=0;i<str.length;i++){
    h ^= str.charCodeAt(i);
    h = (h + ((h<<1) + (h<<4) + (h<<7) + (h<<8) + (h<<24))) >>> 0;
  }
  return h >>> 0;
}
function checksum6(payloadStr){
  const h = fnv1a32(payloadStr);
  return String(h).padStart(10,'0').slice(0,6);
}

/** ========= Timer logic ========= */
function startTimerIfNeeded(){
  if (started) return;
  started = true;
  startEpochMs = Date.now();

  timer = setInterval(()=>{
    remaining -= 1;

    const elapsed = TOTAL_SECONDS - remaining;
    if (!twistUnlocked && elapsed >= TWIST_UNLOCK_AFTER_ELAPSED){
      unlockTwist();
    }

    if (remaining <= 0){
      remaining = 0;
      endGame();
    }
    updateTimers();
    updatePreSubmitSenseCheck();
  }, 1000);

  updateTimers();
}

function updateTimers(){
  el("gameTimer").textContent = fmt(remaining);

  const elapsed = TOTAL_SECONDS - remaining;
  if (!twistUnlocked){
    const untilTwist = Math.max(TWIST_UNLOCK_AFTER_ELAPSED - elapsed, 0);
    el("twistTimer").textContent = fmt(untilTwist);
  } else {
    el("twistTimer").textContent = "UNLOCKED";
  }
}

function unlockTwist(){
  twistUnlocked = true;
  el("twistText").textContent = activeCase.twist.text;
  el("twistBox").classList.add("show");
  toast("üö® Twist unlocked. Add the new evidence and reconsider your tentative answer and gaps.");
}

function addTwistCards(){
  if (!twistUnlocked || twistAdded) return;
  activeCase.twist.cards.forEach(addCardToTray);
  twistAdded = true;
  toast("‚úÖ Twist evidence added.");
}

function endGame(){
  if (timer) clearInterval(timer);
  el("timerBadge").textContent = "‚è±Ô∏è Time is up. Submit now.";
  el("submitBtn").disabled = false;
  toast("‚è±Ô∏è Time is up. Submit your tentative answer + gap types with pinned evidence.");
}

/** ========= Case loading ========= */
function assignRandomCase(){
  if (started) { toast("‚ö†Ô∏è Game already started. Reset to load a new case."); return; }
  const idx = Math.floor(Math.random()*CASES.length);
  loadCase(CASES[idx].id);
}

function loadCase(caseId){
  activeCase = CASES.find(c=>c.id===caseId);

  // reset state
  twistUnlocked = false; twistAdded = false;
  answerPick = null; gapTypePicks = new Set();
  pinned = new Set(); score = 0;
  remaining = TOTAL_SECONDS;
  if (timer) clearInterval(timer);
  started = false;
  startEpochMs = null;

  // render case info
  el("caseTitle").textContent = activeCase.title;
  el("caseSubtitle").textContent = activeCase.subtitle;
  el("problemText").textContent = activeCase.problem;
  el("claimAText").textContent = activeCase.claimA;
  el("claimBText").textContent = activeCase.claimB;

  // clear UI
  clearBoardAndTray();
  el("twistBox").classList.remove("show");
  el("preSubmitCheck").style.display = "none";

  // add initial evidence to tray
  activeCase.cards.forEach(addCardToTray);

  // render choices
  renderAnswerChoices();
  renderGapChoices();

  // enable submit once case is loaded
  el("submitBtn").disabled = false;

  // timer auto-start
  startTimerIfNeeded();
  toast(`‚úÖ Case loaded: ${escapeHTML(activeCase.title)}. Timer started.`);
}

/** ========= Evidence cards ========= */
function addCardToTray(card){
  if (el("card_"+card.id)) return;

  const div = document.createElement("div");
  div.className = "card";
  div.id = "card_"+card.id;
  div.draggable = true;
  div.ondragstart = (e)=> e.dataTransfer.setData("text/plain", card.id);

  const rolesText = card.roles.map(r=>{
    if (r==="claimA") return `<span class="tag">Supports A</span>`;
    if (r==="claimB") return `<span class="tag">Supports B</span>`;
    if (r==="boundary") return `<span class="tag">Boundary/Context</span>`;
    if (r==="methods") return `<span class="tag">Method/Measure</span>`;
    return "";
  }).join("");

  const gapsText = card.gapHints.map(g=>{
    if (g==="THEORETICAL") return `<span class="tag">Theoretical clue</span>`;
    if (g==="CONTEXTUAL") return `<span class="tag">Contextual clue</span>`;
    if (g==="METHODOLOGICAL") return `<span class="tag">Methodological clue</span>`;
    return "";
  }).join("");

  div.innerHTML = `
    <button class="pinBtn" onclick="togglePin('${card.id}')">Pin</button>
    <b>${escapeHTML(card.title)}</b>
    <div class="small" style="margin-top:6px;">${escapeHTML(card.text)}</div>
    <div style="margin-top:8px;">${rolesText}</div>
    <div style="margin-top:6px;">${gapsText}</div>
    <div class="small" style="margin-top:6px;">${(card.meta||[]).map(m=>`‚Ä¢ ${escapeHTML(m)}`).join("<br>")}</div>
  `;
  el("tray").appendChild(div);
  updateCounts();
}

function togglePin(cardId){
  const node = el("card_"+cardId);
  if (!node) return;
  if (pinned.has(cardId)){
    pinned.delete(cardId);
    node.classList.remove("pinned");
  } else {
    pinned.add(cardId);
    node.classList.add("pinned");
  }
  updateCounts();
}

/** ========= Drag & drop ========= */
function allowDrop(e){ e.preventDefault(); }
function bucketOver(e){ e.preventDefault(); e.currentTarget.classList.add("dragover"); }
function bucketLeave(e){ e.currentTarget.classList.remove("dragover"); }

function dropToTray(e){
  e.preventDefault();
  const id = e.dataTransfer.getData("text/plain");
  const cardEl = el("card_"+id);
  if (!cardEl) return;
  el("tray").appendChild(cardEl);
  updateCounts();
}
function dropToBucket(e, which){
  e.preventDefault();
  e.currentTarget.classList.remove("dragover");
  const id = e.dataTransfer.getData("text/plain");
  const cardEl = el("card_"+id);
  if (!cardEl) return;

  const dest = {claimA:el("innerA"),claimB:el("innerB"),boundary:el("innerC"),methods:el("innerM")}[which];
  dest.appendChild(cardEl);
  updateCounts();
}

function updateCounts(){
  el("countA").textContent = el("innerA").children.length;
  el("countB").textContent = el("innerB").children.length;
  el("countC").textContent = el("innerC").children.length;
  el("countM").textContent = el("innerM").children.length;
  updateMetrics();
  updatePreSubmitSenseCheck();
}

/** ========= Final choices ========= */
function renderAnswerChoices(){
  const wrap = el("answerChoices");
  wrap.innerHTML = "";

  const options = [
    { id:"A_TRUE", label:"Claim A is mostly supported", desc:"Most evidence points to Claim A." },
    { id:"B_TRUE", label:"Claim B is mostly supported", desc:"Most evidence points to Claim B." },
    { id:"MIXED_DEPENDS", label:"Mixed results, depends on context", desc:"Studies conflict or differ; context explains why." },
    { id:"INSUFFICIENT", label:"Evidence is insufficient for a clear conclusion", desc:"Methods/measures are too weak to conclude." },
    { id:"BOTH_TRUE_PROCESS_GAP", label:"Both can be true; the process determines outcomes", desc:"Benefits exist, but barriers exclude some users." },
  ];

  options.forEach(o=>{
    const div = document.createElement("div");
    div.className = "choice";
    div.id = "ans_"+o.id;
    div.innerHTML = `<b>${escapeHTML(o.label)}</b><br><small>${escapeHTML(o.desc)}</small>`;
    div.onclick = ()=>pickAnswer(o.id);
    wrap.appendChild(div);
  });
}
function pickAnswer(id){
  answerPick = id;
  [...document.querySelectorAll("#answerChoices .choice")].forEach(x=>x.classList.remove("selected"));
  const node = el("ans_"+id);
  if (node) node.classList.add("selected");
  updateMetrics();
  updatePreSubmitSenseCheck();
}

function renderGapChoices(){
  const wrap = el("gapChoices");
  wrap.innerHTML = "";

  const opts = [
    { id:"THEORETICAL", label:"Theoretical gap", desc:"Explanation is unclear (why/how). Mechanisms not tested." },
    { id:"CONTEXTUAL", label:"Contextual gap", desc:"Missing population/setting/time comparisons (for whom/where/when)." },
    { id:"METHODOLOGICAL", label:"Methodological gap", desc:"Design/measurement limits confidence (how well we know)." },
  ];

  opts.forEach(o=>{
    const div = document.createElement("div");
    div.className = "choice";
    div.id = "gap_"+o.id;
    div.innerHTML = `<b>${escapeHTML(o.label)}</b><br><small>${escapeHTML(o.desc)}</small>`;
    div.onclick = ()=>toggleGapType(o.id);
    wrap.appendChild(div);
  });
}
function toggleGapType(id){
  if (gapTypePicks.has(id)){
    gapTypePicks.delete(id);
    el("gap_"+id).classList.remove("selected");
  } else {
    gapTypePicks.add(id);
    el("gap_"+id).classList.add("selected");
  }
  updateMetrics();
  updatePreSubmitSenseCheck();
}

/** ========= Scoring ========= */
function computeScoreBreakdown(){
  if (!activeCase){
    return { total:0, breakdownLines:[] };
  }

  let breakdown = [];
  let total = 0;

  // Evidence pins
  const pinScore = Math.min(pinned.size * 6, 36);
  total += pinScore;
  breakdown.push(`Evidence support: ${pinScore} points (Pinned ${pinned.size} evidence cards)`);

  // Answer alignment (case-level)
  let answerScore = 0;
  if (answerPick){
    if (answerPick === activeCase.answerKey){
      answerScore = 30;
      breakdown.push(`Tentative answer: 30 points (Best-supported synthesis for this case)`);
    } else {
      answerScore = 12;
      breakdown.push(`Tentative answer: 12 points (Plausible, but not the strongest synthesis given the evidence pattern)`);
    }
  } else {
    breakdown.push(`Tentative answer: 0 points (No answer selected)`);
  }
  total += answerScore;

  // Gap alignment
  const key = new Set(activeCase.gapKey);
  let gapMatches = 0;
  gapTypePicks.forEach(g=>{ if (key.has(g)) gapMatches++; });
  const gapScore = gapMatches * 15;
  total += gapScore;
  breakdown.push(`Gap identification: ${gapScore} points (${gapMatches} strong gap type matches)`);

  // Coherence bonus
  let coherenceBonus = 0;
  const boundaryCount = el("innerC").children.length;
  const methodCount = el("innerM").children.length;

  if (answerPick === "INSUFFICIENT"){
    coherenceBonus = Math.min(methodCount * 3, 15);
  }
  if (answerPick === "MIXED_DEPENDS"){
    coherenceBonus = Math.min(boundaryCount * 3, 15);
  }
  if (answerPick === "BOTH_TRUE_PROCESS_GAP"){
    coherenceBonus = Math.min(boundaryCount * 2, 10);
  }
  if (coherenceBonus > 0){
    breakdown.push(`Synthesis coherence bonus: ${coherenceBonus} points`);
    total += coherenceBonus;
  }

  // Twist bonus
  let twistBonus = 0;
  if (twistUnlocked){
    const pinnedTwist = [...pinned].some(id => id.startsWith("T"));
    if (pinnedTwist){
      twistBonus = 10;
      breakdown.push(`Twist integration bonus: 10 points (Pinned at least one twist card)`);
      total += twistBonus;
    }
  }

  return { total, breakdownLines: breakdown };
}
function computeScore(){
  return computeScoreBreakdown().total;
}

function updateMetrics(){
  const sorted = ["innerA","innerB","innerC","innerM"].reduce((acc,id)=> acc + el(id).children.length, 0);
  el("sortedNum").textContent = sorted;
  el("pinnedNum").textContent = pinned.size;

  score = computeScore();
  el("scoreNum").textContent = score;
}

/** ========= Sense check + colors + warnings ========= */
function cardCurrentBucket(cardId){
  const node = el("card_"+cardId);
  if (!node) return "tray";
  const parent = node.parentElement?.id || "";
  if (parent === "innerA") return "claimA";
  if (parent === "innerB") return "claimB";
  if (parent === "innerC") return "boundary";
  if (parent === "innerM") return "methods";
  if (parent === "tray") return "tray";
  return "tray";
}

function getSortingProfile(){
  return {
    a: el("innerA").children.length,
    b: el("innerB").children.length,
    c: el("innerC").children.length,
    m: el("innerM").children.length
  };
}

function senseCheck(answerPick, pinnedSet){
  const prof = getSortingProfile();
  const totalSorted = prof.a + prof.b + prof.c + prof.m;

  // Count pinned buckets
  let pinA=0, pinB=0, pinC=0, pinM=0;
  [...pinnedSet].forEach(id=>{
    const bucket = cardCurrentBucket(id);
    if (bucket==="claimA") pinA++;
    if (bucket==="claimB") pinB++;
    if (bucket==="boundary") pinC++;
    if (bucket==="methods") pinM++;
  });

  // expected pinned bucket for answer type
  let need = {A:0,B:0,C:0,M:0,msg:""};
  if (answerPick==="A_TRUE"){
    need={A:1,B:0,C:0,M:0,msg:"You selected 'Claim A mostly supported'. Pin at least one Supports A card and show more A evidence than B."};
  } else if (answerPick==="B_TRUE"){
    need={A:0,B:1,C:0,M:0,msg:"You selected 'Claim B mostly supported'. Pin at least one Supports B card and show more B evidence than A."};
  } else if (answerPick==="MIXED_DEPENDS"){
    need={A:0,B:0,C:1,M:0,msg:"You selected 'Mixed/Depends'. You need Boundary/Context evidence explaining what it depends on. Pin at least one Boundary card."};
  } else if (answerPick==="INSUFFICIENT"){
    need={A:0,B:0,C:0,M:1,msg:"You selected 'Insufficient evidence'. You need Method/Measurement Limits evidence. Pin at least one Method card."};
  } else if (answerPick==="BOTH_TRUE_PROCESS_GAP"){
    need={A:0,B:0,C:1,M:0,msg:"You selected 'Both can be true; process matters'. You need Boundary/Context evidence about steps/conditions. Pin at least one Boundary card."};
  }

  // Fit levels
  let fit = "OK";
  let fitWhy = [];

  if (!answerPick){
    fit="Weak";
    fitWhy.push("No tentative answer selected yet.");
  } else {
    if (answerPick==="A_TRUE" && !(prof.a > prof.b && prof.a >= 3)){
      fit="Weak"; fitWhy.push("Your board does not show Supports A clearly dominating.");
    }
    if (answerPick==="B_TRUE" && !(prof.b > prof.a && prof.b >= 3)){
      fit="Weak"; fitWhy.push("Your board does not show Supports B clearly dominating.");
    }
    if (answerPick==="MIXED_DEPENDS" && !(prof.c >= 2)){
      fit="Weak"; fitWhy.push("You chose 'depends' but you have little Boundary/Context evidence sorted.");
    }
    if (answerPick==="INSUFFICIENT" && !(prof.m >= 2)){
      fit="Weak"; fitWhy.push("You chose 'insufficient' but you have little Method/Measurement evidence sorted.");
    }
    if (answerPick==="BOTH_TRUE_PROCESS_GAP" && !(prof.c >= 2)){
      fit="Weak"; fitWhy.push("You chose 'process matters' but you have little Boundary/Context evidence sorted.");
    }
  }

  // Pinned fit
  let pinFit="OK";
  let pinWhy=[];
  if (need.A && pinA<1){ pinFit="Weak"; pinWhy.push("Pin at least 1 Supports A card."); }
  if (need.B && pinB<1){ pinFit="Weak"; pinWhy.push("Pin at least 1 Supports B card."); }
  if (need.C && pinC<1){ pinFit="Weak"; pinWhy.push("Pin at least 1 Boundary/Context card."); }
  if (need.M && pinM<1){ pinFit="Weak"; pinWhy.push("Pin at least 1 Method/Measurement card."); }

  // Promote to Strong if enough sorted + pinned fits
  if (fit!=="Weak" && pinFit!=="Weak" && totalSorted>=8 && pinnedSet.size>=2){
    fit="Strong"; pinFit="Strong";
  } else if (fit!=="Weak" && pinFit!=="Weak" && totalSorted>=6){
    fit="OK"; pinFit="OK";
  } else {
    if (fit==="OK" && totalSorted<6) { fit="Weak"; fitWhy.push("Sort more evidence cards to strengthen your synthesis."); }
  }

  return {
    sortingProfile: prof,
    pinBuckets: {pinA,pinB,pinC,pinM},
    fit,
    pinFit,
    coaching: [need.msg, ...fitWhy, ...pinWhy].filter(Boolean)
  };
}

function levelToPill(level){
  if (level==="Strong") return `<span class="statusPill status-green">Strong</span>`;
  if (level==="OK") return `<span class="statusPill status-yellow">OK</span>`;
  return `<span class="statusPill status-red">Weak</span>`;
}

function updatePreSubmitSenseCheck(){
  if (!activeCase) return;
  const team = (el("teamName").value||"").trim();
  const anySelected = !!answerPick || gapTypePicks.size>0 || pinned.size>0;
  if (!anySelected){ el("preSubmitCheck").style.display="none"; return; }

  const sc = senseCheck(answerPick, pinned);
  const needWarn = (sc.fit==="Weak" || sc.pinFit==="Weak");

  el("preSubmitCheck").style.display = "block";
  el("preSubmitCheck").style.borderLeftColor = needWarn ? "var(--badLine)" : "var(--okLine)";
  el("preSubmitBody").innerHTML = `
    <div>Sorting‚ÄìAnswer Fit: ${levelToPill(sc.fit)} &nbsp; | &nbsp; Pinned Evidence Fit: ${levelToPill(sc.pinFit)}</div>
    <div class="small" style="margin-top:6px;">
      Board counts: A=${sc.sortingProfile.a}, B=${sc.sortingProfile.b}, Context=${sc.sortingProfile.c}, Method=${sc.sortingProfile.m}<br>
      Pinned-from buckets: A=${sc.pinBuckets.pinA}, B=${sc.pinBuckets.pinB}, Context=${sc.pinBuckets.pinC}, Method=${sc.pinBuckets.pinM}
    </div>
    <div class="small" style="margin-top:6px;">
      <b>Fix before submit:</b><br>
      ${sc.coaching.map(x=>`‚Ä¢ ${escapeHTML(x)}`).join("<br>")}
    </div>
    ${team ? "" : `<div class="small" style="margin-top:6px;"><b>Reminder:</b> Add your Team name before submitting.</div>`}
  `;
}

/** ========= Reflection sentence auto-generator ========= */
function gapLabel(g){
  if (g==="THEORETICAL") return "theoretical";
  if (g==="CONTEXTUAL") return "contextual";
  if (g==="METHODOLOGICAL") return "methodological";
  return g;
}

function makeReflectionSentence(){
  const team = (el("teamName").value||"").trim();
  const c = activeCase?.title || "this case";
  const gaps = [...gapTypePicks].map(gapLabel);
  const gText = gaps.length ? gaps.join(" and ") : "a research gap";
  const sc = senseCheck(answerPick, pinned);
  const counts = sc.sortingProfile;
  const evidenceSummary = `we organized evidence across A=${counts.a}, B=${counts.b}, Context=${counts.c}, Method=${counts.m}`;
  const twistNote = twistUnlocked ? (twistAdded ? "and updated our synthesis after the twist evidence." : "but did not add twist evidence.") : "and no twist evidence was available yet.";

  return `In ${c}, our team reached a tentative answer of "${answerPick || "N/A"}" because ${evidenceSummary}. We identified a ${gText} by noting what the literature still cannot explain or generalize, and we justified this using pinned evidence. We treated the RRL as synthesis (patterns, contradictions, boundaries) rather than a list of summaries, ${twistNote}`;
}

/** ========= Portable submission code ========= */
function makeSubmissionCode(payloadObj){
  const payloadStr = JSON.stringify(payloadObj);
  const payloadB64 = b64urlEncode(payloadStr);
  const sig = checksum6(payloadStr);
  return `RRL1-${payloadB64}-${sig}`;
}
function parseSubmissionCode(code){
  code = (code||"").trim();
  if (!code.startsWith("RRL1-")) return { ok:false, err:"Not an RRL1 code" };
  const parts = code.split("-");
  if (parts.length < 3) return { ok:false, err:"Invalid format" };
  const sig = parts[parts.length-1];
  const payloadB64 = parts.slice(1, parts.length-1).join("-");
  let payloadStr;
  try{ payloadStr = b64urlDecode(payloadB64); } catch(e){ return { ok:false, err:"Cannot decode payload" }; }
  const expected = checksum6(payloadStr);
  if (expected !== sig) return { ok:false, err:"Checksum mismatch" };
  let obj;
  try{ obj = JSON.parse(payloadStr); } catch(e){ return { ok:false, err:"Payload not JSON" }; }
  return { ok:true, obj };
}

/** ========= Submit (with sense-check warning + colored feedback + reflection) ========= */
function submit(){
  if (!activeCase){ toast("‚ö†Ô∏è Load a case first."); return; }
  const team = (el("teamName").value||"").trim();
  if (!team){ toast("‚ö†Ô∏è Please enter your Team name (required)."); return; }
  if (!answerPick){ toast("‚ö†Ô∏è Choose a tentative answer first."); return; }
  if (gapTypePicks.size === 0){ toast("‚ö†Ô∏è Select at least one gap type."); return; }
  if (pinned.size < 2){ toast("‚ö†Ô∏è Pin at least 2 evidence cards to support your answer."); return; }

  // Warning BEFORE submit: logic weak
  const scPre = senseCheck(answerPick, pinned);
  if (scPre.fit === "Weak" || scPre.pinFit === "Weak"){
    const proceed = confirm(
      "Your Sense Check is WEAK.\n\n" +
      "This usually means your answer does not match how you sorted/pinned evidence.\n\n" +
      "Click OK to submit anyway, or Cancel to revise."
    );
    if (!proceed) return;
  }

  const { total, breakdownLines } = computeScoreBreakdown();

  const payload = {
    v: 1,
    team,
    caseId: activeCase.id,
    caseTitle: activeCase.title,
    score: total,
    answer: answerPick,
    gaps: [...gapTypePicks],
    pinned: [...pinned],
    sortedCounts: getSortingProfile(),
    twistUnlocked,
    twistAdded,
    submittedAt: new Date().toISOString()
  };
  const submissionCode = makeSubmissionCode(payload);

  const sc = senseCheck(answerPick, pinned);
  const reflection = makeReflectionSentence();

  el("result").style.display = "block";
  el("result").innerHTML = `
    <b>‚úÖ Submission Complete</b><br>
    <div class="small" style="margin-top:6px;">
      <b>Team:</b> ${escapeHTML(team)}<br>
      <b>Case:</b> ${escapeHTML(activeCase.title)}<br>
      <b>Total Score:</b> ${total}<br><br>

      <b>Score Breakdown</b><br>
      ${breakdownLines.map(b=>`‚Ä¢ ${escapeHTML(b)}`).join("<br>")}<br><br>

      <b>Sense Check (self-evaluation)</b><br>
      ‚Ä¢ <b>Sorting‚ÄìAnswer Fit:</b> ${levelToPill(sc.fit)}<br>
      ‚Ä¢ <b>Pinned Evidence Fit:</b> ${levelToPill(sc.pinFit)}<br>
      ‚Ä¢ <b>Your board counts:</b> A=${sc.sortingProfile.a}, B=${sc.sortingProfile.b}, Context=${sc.sortingProfile.c}, Method=${sc.sortingProfile.m}<br>
      ‚Ä¢ <b>Pinned-from buckets:</b> A=${sc.pinBuckets.pinA}, B=${sc.pinBuckets.pinB}, Context=${sc.pinBuckets.pinC}, Method=${sc.pinBuckets.pinM}<br>
      <div class="small" style="margin-top:6px;">
        <b>What to improve next time:</b><br>
        ${sc.coaching.map(x=>`‚Ä¢ ${escapeHTML(x)}`).join("<br>")}
      </div><br>

      <b>Reflection sentence (copy/paste)</b><br>
      <div class="mono" style="padding:10px;border:1px solid var(--line);border-radius:10px;background:#fff;white-space:pre-wrap;">
        ${escapeHTML(reflection)}
      </div>
      <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:10px;">
        <button class="secondary" onclick="copyText(${JSON.stringify(reflection)})">Copy Reflection</button>
      </div><br>

      <b>Submission Code (send this to your instructor):</b><br>
      <div class="mono" style="padding:10px;border:1px solid var(--line);border-radius:10px;background:#fff;word-break:break-all;">
        ${escapeHTML(submissionCode)}
      </div>
      <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:10px;">
        <button class="secondary" onclick="copyText(${JSON.stringify(submissionCode)})">Copy Code</button>
        <button class="secondary" onclick="copyText(${JSON.stringify(team + ' | ' + submissionCode)})">Copy Team + Code</button>
      </div>
      <div class="tinyNote">Paste to chat/LMS exactly as copied. One line (but instructor parser can handle wrapped codes).</div>
    </div>
  `;
  el("result").scrollIntoView({behavior:"smooth", block:"start"});
}

/** ========= Hint ========= */
function hint(){
  if (!activeCase){ toast("Hint: Load a random case."); return; }
  if (!answerPick){
    toast("Hint: Choose a tentative answer based on the overall pattern. If findings differ, try 'Mixed results' or 'Both can be true'.");
    return;
  }
  if (gapTypePicks.size === 0){
    toast("Hint: Why/how missing = theoretical. For whom/where/when missing = contextual. Weak design/measures = methodological.");
    return;
  }
  if (pinned.size < 2){
    toast("Hint: Pin your strongest evidence. If you can‚Äôt pin 2 strong cards, your claim may be weak.");
    return;
  }
  if (twistUnlocked && !twistAdded){
    toast("Hint: Twist is unlocked. Add twist evidence and consider updating your tentative answer and gap.");
    return;
  }
  toast("Hint: Improve by making your answer match your Boundary/Method sorting and by pinning the right kinds of evidence.");
}

/** ========= Reset ========= */
function clearBoardAndTray(){
  ["tray","innerA","innerB","innerC","innerM"].forEach(id=> el(id).innerHTML = "");
  el("countA").textContent = "0";
  el("countB").textContent = "0";
  el("countC").textContent = "0";
  el("countM").textContent = "0";
  el("result").style.display = "none";
  el("result").innerHTML = "";
  updateMetrics();
}

function resetAll(){
  if (timer) clearInterval(timer);
  location.reload();
}

/** ========= Toast ========= */
function toast(html){
  const t = el("result");
  t.style.display = "block";
  t.innerHTML = html;
  t.scrollIntoView({behavior:"smooth", block:"start"});
}
function copyText(txt){
  navigator.clipboard.writeText(txt).then(()=>toast("‚úÖ Copied to clipboard."));
}

/** ========= Instructor Dashboard + robust parsing + analytics ========= */
let parsedRows = [];

function toggleInstructor(){
  const p = el("instructorPanel");
  p.classList.toggle("show");
  if (p.classList.contains("show")){
    el("codesInput").focus();
  }
}

function clearInstructor(){
  el("codesInput").value = "";
  el("resultsTable").innerHTML = "";
  el("parseSummary").textContent = "";
  el("analyticsGrid").innerHTML = "";
  parsedRows = [];
}

function extractAllCodesFromText(raw){
  // Robust: pull all occurrences even if wrapped
  // Match RRL1- + base64url-ish + - + 6 digits
  const re = /RRL1-[A-Za-z0-9\-_]+-[0-9]{6}/g;
  const matches = raw.match(re) || [];
  // De-duplicate while preserving order
  const seen = new Set();
  const out = [];
  for (const m of matches){
    if (!seen.has(m)){ seen.add(m); out.push(m); }
  }
  return out;
}

function parseCodes(){
  const raw = el("codesInput").value || "";
  const codes = extractAllCodesFromText(raw);

  parsedRows = [];
  let ok=0, bad=0;

  // If no codes found, fall back to line parsing (maybe they pasted only codes, one per line)
  const linesFallback = raw.split(/\r?\n/).map(x=>x.trim()).filter(Boolean);

  const items = codes.length ? codes : linesFallback;

  items.forEach(item=>{
    const parsed = parseSubmissionCode(item);
    if (parsed.ok){
      ok++;
      parsedRows.push({ ok:true, ...parsed.obj, code:item });
    } else {
      bad++;
      parsedRows.push({ ok:false, err: parsed.err, raw: item });
    }
  });

  el("parseSummary").textContent = codes.length
    ? `Found ${codes.length} code(s) in pasted text: ${ok} valid, ${bad} invalid.`
    : `Parsed ${items.length} line(s): ${ok} valid, ${bad} invalid.`;

  renderResultsTable();
  renderAnalytics();
}

function renderResultsTable(){
  const tbl = el("resultsTable");
  if (!parsedRows.length){ tbl.innerHTML = ""; return; }

  const headers = ["Status","Team","Case","Score","Answer","Gaps","Pinned","Twist Used","Submitted At","Code/Error"];
  let html = `<tr>${headers.map(h=>`<th>${escapeHTML(h)}</th>`).join("")}</tr>`;

  parsedRows.forEach(r=>{
    if (r.ok){
      const twistUsed = r.twistUnlocked ? (r.twistAdded ? "Yes" : "Unlocked only") : "No";
      html += `<tr>
        <td><span class="statusPill status-green">OK</span></td>
        <td>${escapeHTML(r.team||"")}</td>
        <td>${escapeHTML(r.caseTitle||r.caseId||"")}</td>
        <td>${escapeHTML(String(r.score ?? ""))}</td>
        <td>${escapeHTML(r.answer||"")}</td>
        <td>${escapeHTML((r.gaps||[]).join(", "))}</td>
        <td>${escapeHTML((r.pinned||[]).join(", "))}</td>
        <td>${escapeHTML(twistUsed)}</td>
        <td>${escapeHTML(r.submittedAt||"")}</td>
        <td class="mono">${escapeHTML(r.code||"")}</td>
      </tr>`;
    } else {
      html += `<tr style="background:var(--bad);">
        <td><span class="statusPill status-red">BAD</span></td>
        <td colspan="8"></td>
        <td class="mono">${escapeHTML((r.err||"Error") + " | " + (r.raw||""))}</td>
      </tr>`;
    }
  });

  tbl.innerHTML = html;
}

function renderAnalytics(){
  const grid = el("analyticsGrid");
  const valid = parsedRows.filter(r=>r.ok);
  if (!valid.length){
    grid.innerHTML = "";
    return;
  }

  const scores = valid.map(v=>Number(v.score||0));
  const avg = scores.reduce((a,b)=>a+b,0)/scores.length;
  const min = Math.min(...scores);
  const max = Math.max(...scores);

  const band = (s)=>{
    if (s>=85) return "85‚Äì100";
    if (s>=70) return "70‚Äì84";
    if (s>=50) return "50‚Äì69";
    return "0‚Äì49";
  };
  const bands = {"85‚Äì100":0,"70‚Äì84":0,"50‚Äì69":0,"0‚Äì49":0};
  scores.forEach(s=>bands[band(s)]++);

  const byCase = {};
  valid.forEach(v=>{
    const k = v.caseTitle || v.caseId || "Unknown";
    byCase[k] = (byCase[k]||0)+1;
  });

  const gapCounts = {THEORETICAL:0, CONTEXTUAL:0, METHODOLOGICAL:0};
  valid.forEach(v=>{
    (v.gaps||[]).forEach(g=>{
      if (gapCounts[g] !== undefined) gapCounts[g] += 1;
    });
  });

  const ansCounts = {};
  valid.forEach(v=>{
    const a = v.answer || "None";
    ansCounts[a] = (ansCounts[a]||0)+1;
  });

  const mostCommon = (obj)=>{
    const entries = Object.entries(obj).sort((a,b)=>b[1]-a[1]);
    return entries.slice(0,5).map(([k,v])=>`${k}: ${v}`).join("<br>");
  };

  grid.innerHTML = `
    <div class="analyticsCard">
      <b>Score Summary</b>
      <div class="muted">Submissions: ${valid.length}</div>
      <div class="muted">Avg: ${avg.toFixed(1)} | Min: ${min} | Max: ${max}</div>
      <div class="muted" style="margin-top:6px;">
        ${Object.entries(bands).map(([k,v])=>`${k}: ${v}`).join("<br>")}
      </div>
    </div>
    <div class="analyticsCard">
      <b>Cases Played</b>
      <div class="muted">${mostCommon(byCase) || "‚Äî"}</div>
    </div>
    <div class="analyticsCard">
      <b>Gap Types Chosen</b>
      <div class="muted">
        THEORETICAL: ${gapCounts.THEORETICAL}<br>
        CONTEXTUAL: ${gapCounts.CONTEXTUAL}<br>
        METHODOLOGICAL: ${gapCounts.METHODOLOGICAL}
      </div>
      <div class="muted" style="margin-top:6px;"><b>Answers chosen</b><br>${mostCommon(ansCounts) || "‚Äî"}</div>
    </div>
  `;
}

function downloadCSV(){
  if (!parsedRows.length){
    toast("‚ö†Ô∏è Nothing to export. Paste codes and click Parse first.");
    return;
  }
  const valid = parsedRows.filter(r=>r.ok);
  if (!valid.length){
    toast("‚ö†Ô∏è No valid rows to export.");
    return;
  }

  const cols = ["team","caseId","caseTitle","score","answer","gaps","pinned","twistUnlocked","twistAdded","submittedAt","code"];
  const lines = [];
  lines.push(cols.join(","));
  valid.forEach(r=>{
    const row = cols.map(c=>{
      let v = r[c];
      if (Array.isArray(v)) v = v.join(";");
      v = (v ?? "").toString().replace(/"/g,'""');
      return `"${v}"`;
    }).join(",");
    lines.push(row);
  });

  const blob = new Blob([lines.join("\n")], {type:"text/csv;charset=utf-8;"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "rrl_detective_submissions.csv";
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
}

/** ========= Initial timer display ========= */
el("gameTimer").textContent = fmt(remaining);
el("twistTimer").textContent = fmt(TWIST_UNLOCK_AFTER_ELAPSED);
</script>

  <footer class="ai-footer">
  <div class="ai-footer-content">
    <p>
      <strong>AI Disclosure:</strong> This activity was designed with the assistance of AI in generating HTML and interface code. 
      The game mechanics, instructional design, and learning structure are original work of the instructor.
    </p>
    <p>
      Designed for the Research Methods course of <strong>Dr. Jessica Jaye S. Ranieses</strong>.
    </p>
  </div>
</footer>

</body>
</html>
